<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
   <link href="https://fonts.googleapis.com/css2?family=Anton&family=Open+Sans&display=swap" rel="stylesheet">
   <link rel="icon" href="https://isnanswc.github.io/gambar/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
   <title>Manajemen Label - PT. Saptawarna Cemerlang</title>
  <style>
    /* ===== BASE STYLES ===== */
    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: Arial, sans-serif; 
      line-height: 1.6;
      color: #333;
    }
    
    body.no-scroll {
    overflow: hidden; /* Ini adalah properti utama untuk mengunci scroll */
    position: fixed; /* Memastikan body tidak bergerak saat scroll */
    width: 100%; /* Mempertahankan lebar */
    height: 100%; /* Mempertahankan tinggi */
    top: 0; /* Penting untuk mengunci di posisi paling atas */
    left: 0;
}

    /* ===== LAYOUT STYLES ===== */
    .container {
      padding: 20px;
      width: 100%;
      overflow-x: auto;
    }
    
    /* ===== NAVIGATION ===== */
    nav {
      position: sticky;
      top: 0;
      background: #f8f8f8;
      padding: 10px 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ccc;
      z-index: 10;
    }
    
    .nav-left { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
    }
    
    .nav-links {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .nav-toggle {
      display: none;
      font-size: 20px;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    /* ===== TABLE STYLES ===== */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
      white-space: nowrap;
    }
    
    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: center;
      position: relative;
    }
    
    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
    }
    
    /* ===== MODAL STYLES ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    /* Update form-container layout */
/* Update form-container layout */
.form-container {
  display: flex; /* Susunan horizontal */
  flex-wrap: wrap;
  gap: 20px;
  font-size: 12px;
}

.form-section {
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  padding: 10px;
  background: #f9f9f9;
  width: calc(33.33% - 15px); /* 3 kolom */
  box-sizing: border-box;
  min-width: 280px; /* agar tidak terlalu sempit di layar kecil */
}

.form-section-title {
  font-weight: bold;
  font-size: 13px;
  margin-bottom: 6px;
  color: #2c3e50;
  border-bottom: 1px solid #ddd;
  padding-bottom: 3px;
}

.form-row {
  display: flex;
  align-items: center;
  margin-bottom: 6px;
}

.form-row label {
  width: 90px;
  font-size: 12px;
  margin-right: 6px;
}

.form-row input,
.form-row select,
.form-row textarea {
  flex: 1;
  padding: 4px 6px;
  font-size: 12px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.form-buttons {
  grid-column: span 2;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}
    
    .auto-input {
      background-color: #f5f5f5;
      color: #666;
      cursor: not-allowed;
    }
    
    
    
    /* ===== BUTTON STYLES ===== */
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 80px;
      text-align: center;
    }
    
    .btn-primary {
      background-color: #4CAF50;
      color: white;
    }
    
    .btn-secondary {
      background-color: #2196F3;
      color: white;
    }
    
    .btn-danger {
      background-color: #f44336;
      color: white;
    }
    
    .btn-warning {
      background-color: #FF9800;
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      opacity: 0.9;
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .button-icon {
      width: 16px;
      height: 16px;
    }
    
    /* ===== LABEL PREVIEW STYLES ===== */
    .preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    
    .preview-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .label-preview-content {
  border: 2px solid black;
  padding: 10px;
  margin-bottom: 20px;
  page-break-inside: avoid;
  border-bottom: 3px dashed #000; /* Garis putus-putus hitam */
   max-height: 980px;
  overflow: hidden;
  page-break-inside: avoid;
}
    
    .label-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .label-table td {
      border: 1px solid black;
      padding: 4px 6px;
    }
    
    .label-subtitle {
      font-weight: bold;
      font-size: 16px;
      text-align: center;
    }
    
    .label-pass {
      background: #4CAF50;
      color: white;
      font-weight: bold;
      padding: 0 10px;
      -webkit-print-color-adjust: exact;
    }
    
    .label-fail {
      background: yellow;
      color: red;
      font-weight: bold;
      padding: 0 10px;
      -webkit-print-color-adjust: exact;
    }
    
    .label-reject {
      background: red;
      color: white;
      font-weight: bold;
      padding: 0 10px;
      -webkit-print-color-adjust: exact;
    }
    
    /* ===== UTILITY STYLES ===== */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mt-10 {
      margin-top: 10px;
    }
    
    .mb-10 {
      margin-bottom: 10px;
    }
    
    /* ===== RESPONSIVE STYLES ===== */
    @media (max-width: 768px) {
      .form-container {
        grid-template-columns: 1fr;
      }
      
      .form-buttons {
        grid-column: span 1;
      }
      
      .nav-toggle {
        display: none;
        font-size: 20px;
        background: none;
        border: none;
        cursor: pointer;
      }
      
      .nav-links {
        width: 100%;
        flex-direction: column;
        display: none;
        margin-top: 10px;
      }
      
      .nav-links.active {
        display: flex;
      }
      
      .form-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .form-row label {
        width: 100%;
        margin-bottom: 5px;
      }
    }
    
    @media print {
      body * {
        visibility: hidden;
      }
      
      #printArea, #printArea * {
        visibility: visible;
      }
      
      #printArea {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
      }

        .label-preview-content {
    page-break-inside: avoid;
    break-inside: avoid;
  }
    }

     /* ===== RADIO GROUP STYLES ===== */
  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 5px;
  }
  
  .radio-option {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .radio-option input[type="radio"] {
    margin: 0;
  }
  
  .radio-option label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 14px;
  }
  
  /* Khusus untuk input numeric di radio option */
  .radio-numeric-input {
    width: 115px;
    margin-left: 10px;
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .form-row select {
  flex: 1;
  padding: 8px 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  background-color: white;
}

/* Machine Type Styles */
.machine-slitting {
  background-color: #4CAF50;
  color: white;
  font-weight: bold;
  padding: 2px 5px;
  border-radius: 3px;
  -webkit-print-color-adjust: exact;
}

.B-grade {
  background-color: #ae0fd6;
  color: white;
  font-weight: bold;
  padding: 2px 5px;
  border-radius: 3px;
  -webkit-print-color-adjust: exact;
}

.machine-rewind {
  background-color: #2196F3;
  color: white;
  font-weight: bold;
  padding: 2px 5px;
  border-radius: 3px;
  -webkit-print-color-adjust: exact;
}

.machine-sml {
  background-color: #FF9800;
  color: white;
  font-weight: bold;
  padding: 2px 5px;
  border-radius: 3px;
  -webkit-print-color-adjust: exact;
}

@media print {
  @page {
    size: auto;  /* auto adalah nilai awal */
    margin: 0mm; /* ini memengaruhi margin halaman */
  }
  
  /* Sembunyikan header/footer browser */
  body::after {
    display: none !important;
  }
}

/* Tambahkan ini di bagian CSS */
.qr-code-container {
  width: 15px !important;
  height: 15px !important;
  padding: 0 !important;
  margin: 0 !important;
}

.qr-code-img {
  width: 100% !important;
  height: 100% !important;
  object-fit: contain;
}

.label-table tr {
  height: 20px; /* Sesuaikan dengan kebutuhan */
}
.label-table td {
  vertical-align: middle;
}

@media print {
  .qr-code-img {
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
}


/* Tambahkan di bagian CSS */
#tanggalManual {
  flex: 1;
  padding: 8px 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

/* Add this to the CSS */
.search-container {
  flex: 1;
  margin: 0 20px;
  max-width: 300px;
}

.search-container input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.bulk-actions {
  display: none;
  gap: 10px;
}

.bulk-actions.visible {
  display: flex;
}

/* Add this to your CSS */
table td[style*="color: red"] {
  background-color: red !important;
}

@page {
  size: A4 portrait;
  margin: 0mm;
}

/* ===== RESPONSIVE NAVIGATION ===== */
@media (max-width: 960px) {
  nav {
    flex-direction: column;
    align-items: flex-start;
  }

  .nav-links {
    width: 100%;
    justify-content: space-between;
    flex-wrap: wrap;
  }

  .search-storage-wrapper {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
  }

  .search-container {
    width: 100%;
  }

  .search-container input {
    width: 100%;
  }
}

@media (max-width: 768px) {
  .form-container {
    grid-template-columns: 1fr;
  }

  .nav-toggle {
    display: inline-block;
  }

  .nav-links {
    display: none;
    flex-direction: column;
    margin-top: 10px;
  }

  .nav-links.active {
    display: flex;
  }

  .form-row label {
    width: 100%;
    margin-bottom: 5px;
  }
}

.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 1100px; /* Lebar maksimal */
  max-height: 90vh;
  overflow-y: auto;
}

#pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.pagination-btn {
  padding: 6px 12px;
  border: none;
  background-color: #e0e0e0;
  color: #333;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 500;
}

.pagination-btn:hover {
  background-color: #d0d0d0;
}

.pagination-btn.active {
  background-color: #2196F3;
  color: white;
  box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.4);
}

.pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-content {
  background-color: #fff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

#deletePasswordInput {
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
  padding: 6px 10px;
}
#deletePasswordInput:focus {
  outline: none;
  border-color: #2196F3;
  box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
}
  </style>
</head>
<body>
  <nav>
  <div class="nav-left">
    <h2>Manajemen Label</h2>
    <button class="nav-toggle" onclick="toggleNav()">☰</button>
  </div>

  <div class="nav-links" id="navLinks">
    <button class="btn btn-primary" onclick="openModal()">
      <svg class="button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/></svg>
      Tambah Data
    </button>

    <div class="bulk-actions" id="bulkActions">
      <button class="btn btn-secondary" onclick="previewSelected()">
        <svg class="button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,16.39 1,12C2.73,7.61 7,4.5 12,4.5Z"/></svg>
        Preview terpilih
      </button>
      
      <button class="btn btn-danger" onclick="deleteSelected()">
        <svg class="button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
        Hapus terpilih
      </button>
    </div>
<button class="btn btn-danger" onclick="showDeleteAllModal()">Hapus Semua</button>
    <button class="btn btn-warning" onclick="exportToExcel()">
      <svg class="button-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
      Export Excel
    </button>
  </div>

  <div class="search-storage-wrapper">
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Cari data..." oninput="searchData()" />
    </div>
    <div id="storageInfo" title="Kapasitas localStorage yang digunakan"
         style="font-size:12px; margin-top:8px;">
      Memori: <span id="storagePercent">0%</span>
      <div id="storageBar" style="height:5px; background:#ccc; border-radius:3px; overflow:hidden;">
        <div id="storageFill" style="height:100%; width:0%; background:#4CAF50;"></div>
      </div>
    </div>
  </div>
</nav>

  <div id="topPagination" class="text-center mt-10">
  <button class="btn btn-secondary" onclick="prevPage()">Previous</button>
  <span id="topPageNumbers"></span>
  <button class="btn btn-secondary" onclick="nextPage()">Next</button>
</div>

  <div class="container">
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" onclick="toggleAll(this)" /></th>
          <th>No</th>
          <th>UNIQ ID</th>
          <th>Tanggal</th>
          <th>Mesin</th>
          <th>Supplier</th>
          <th>SPK</th>
          <th>No. Lot</th>
          <th>Dimensi</th>
          <th>Kode Pack</th>
          <th>Bulan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="dataBody"></tbody>
    </table>
    
  </div>
<div id="bottomPagination" class="text-center mt-10">
  <button class="btn btn-secondary" onclick="prevPage()">Previous</button>
  <span id="bottomPageNumbers"></span>
  <button class="btn btn-secondary" onclick="nextPage()">Next</button>
</div>
  <div class="modal" id="modal">
  <div class="modal-content">
    <form id="labelForm">
      <input type="hidden" name="index" id="formIndex" />

      <div class="form-container">

        <div class="form-section">
          <div class="form-section-title">Info Dasar</div>

          <div class="form-row">
            <label for="supplier">Supplier</label>
            <input name="supplier" value="INHOUSE" required />
          </div>

          <div class="form-row">
            <label for="spk">SPK</label>
            <input name="spk" required />
          </div>

          <div class="form-row">
            <label for="tanggal">Tanggal</label>
            <input type="date" name="tanggal" class="auto-input" readonly />
          </div>

          <div class="form-row">
            <label for="mesin">Mesin</label>
            <select name="mesin" id="mesinSelect" required onchange="updateAutoFields()">
              <option value="SLITTING">SLITTING</option>
              <option value="REWIND">REWIND</option>
              <option value="SML">SML</option>
            </select>
          </div>

          <div class="form-row">
            <label for="jenis">Jenis</label>
            <input list="jenisList" name="jenis" required />
          </div>

          <div class="form-row">
            <label for="type">Type</label>
            <select name="type" required>
              <option>TRANSPARENT</option>
              <option>METALIZED</option>
              <option>MATTE</option>
              <option>GLOSSY</option>
            </select>
          </div>

        </div>

        <div class="form-section">
          <div class="form-section-title">Dimensi & Hasil</div>

          <div class="form-row">
            <label for="thickness">Thickness</label>
            <input name="thickness" required />
          </div>

          <div class="form-row">
            <label for="width">Width</label>
            <input name="width" required />
          </div>

          <div class="form-row">
            <label for="length">Length</label>
            <input name="length" required />
          </div>

          <div class="form-row">
            <label for="meter">Meter</label>
            <input name="meter" required />
          </div>

          <div class="form-row">
            <label for="joint">Joint</label>
            <input name="joint" required />
          </div>

          <div class="form-row">
            <label for="netto">Netto</label>
            <input name="netto" class="auto-input" readonly />
          </div>

          <div class="form-row">
            <label for="paperCore">Paper Core</label>
            <input name="paperCore" class="auto-input" readonly />
          </div>

        </div>

        <div class="form-section">
          <div class="form-section-title">Otomatis & Status</div>

          <div class="form-row">
            <label for="tanggalShift">Tgl Shift</label>
            <input name="tanggalShift" id="tanggalShift" class="auto-input" readonly />
          </div>

          <div class="form-row">
            <label for="tanggalManual">Tgl Manual</label>
            <input type="date" name="tanggalManual" id="tanggalManual" />
          </div>

          <div class="form-row">
            <label for="kodePack">Kode Pack</label>
            <input name="kodePack" class="auto-input" readonly />
          </div>

          <div class="form-row">
            <label for="status">Status</label>
            <input name="status" class="auto-input" readonly />
          </div>
          <div class="form-row">
            <label for="treatment">Treatment</label>
            <select name="treatment"><option>INSIDE</option></select>
          </div>
          <div class="form-row">
            <label for="od">OD</label>
            <input name="od" id="odInput" value="OD2.4" />
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title">No Lot & Keterangan</div>

          <div class="form-row">
            <label for="lot">No Lot</label>
            <input name="lot" required />
          </div>

          <div class="form-row">
            <label for="turunan">Turunan</label>
            <input name="turunan" required />
          </div>

          <div class="form-row">
            <label for="kode">Kode Formula</label>
            <input name="kode" required />
          </div>

          <div class="form-row">
            <label for="keterangan">Ket:</label>
            <textarea name="keterangan" style="height: 50px;"></textarea>
          </div>

        </div>

        <div class="form-section">
          <div class="form-section-title">Sub Kode Pack</div>

          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" name="subKodeType" value="numeric" checked onchange="handleSubKode()" />
              <label>
                PASS
                <input type="text" name="subKodeNumeric" id="subKodeNumeric"
                       oninput="formatSubKode(this)" maxlength="4"
                       class="radio-numeric-input" style="width: 70px;" />
              </label>
            </div>
            <div class="radio-option">
              <input type="radio" name="subKodeType" value="reject" onchange="handleSubKode()" />
              <label>REJECT</label>
            </div>
            <div class="radio-option">
              <input type="radio" name="subKodeType" value="hold" onchange="handleSubKode()" />
              <label>HOLD</label>
            </div>
            <input type="hidden" name="subKode" id="subKodeValue" />
          </div>
        </div>
         <div class="form-section">

           <div class="form-row">
            <label for="jenisPrint">Jenis Print</label>
            <select name="jenisPrint" id="jenisPrint">
              <option value="FINISH GOODS">FINISH GOODS</option>
              <option value="B-GRADE">B-GRADE</option>
            </select>
          </div>

          <div class="form-row">
            <label for="uniqID">Label ID</label>
            <input name="uniqId" id="uniqId" class="auto-input" readonly />
          </div>

          <div class="form-row">
            <span for="kode">OD STANDARD VMCPP = OD2.4</span>
          </div>
          <div class="form-row">
            <span for="kode">OD STANDARD VMPET = OD3.2</span>
          </div>
        </div>

      </div>

      <div class="form-buttons">
        <button type="submit" class="btn btn-primary">Simpan</button>
        <button type="button" onclick="closeModal()" class="btn btn-danger">Batal</button>
      </div>
    </form>
  </div>
</div>

  <div class="preview-modal modal" id="previewModal">
    <div class="preview-content">
      <div id="printArea"></div>
      <div style="text-align: right; margin-top: 10px;">
        <button class="btn btn-primary" onclick="print()">Print</button>
        <button class="btn btn-danger" onclick="closePreview()">Tutup</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js "></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    // ===== CONSTANTS =====
    let currentPage = 1;
const rowsPerPage = 50;
    const DATA_KEY = "labelData";
    const form = document.getElementById("labelForm");
    let currentEditIndex = -1;
    
    // ===== INITIALIZATION =====

    function generateUniqID() {
  return 'LBL-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase();
}

    document.addEventListener('DOMContentLoaded', function() {
      updateLocalStorageAndMonitor();
      setupEventListeners();
    });
    
    // ===== EVENT LISTENERS SETUP =====
    function setupEventListeners() {
      // Form submission
      form.addEventListener("submit", handleFormSubmit);
      
      // Input changes that trigger calculations
      document.querySelectorAll('#labelForm input, #labelForm select').forEach(el => {
        if (!el.readOnly) {
          el.addEventListener('input', updateAutoFields);
        }
      });
      
      // Type change for OD field
      document.querySelector('select[name="type"]').addEventListener('change', handleTypeChange);
      
      // Sub kode numeric input
      document.getElementById('subKodeNumeric').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        handleSubKode();
      });

      document.getElementById('tanggalManual').addEventListener('change', function() {
        // Ketika tanggalManual diubah, panggil updateAutoFields untuk memperbarui tanggal otomatis lainnya.
        updateAutoFields();
      });
    }
    
    // ===== NAVIGATION FUNCTIONS =====
    function toggleNav() {
      document.getElementById("navLinks").classList.toggle("active");
    }
    
    // ===== DATA FORMATTING FUNCTIONS =====
    function getMonthName(dateStr) {
      const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", 
                     "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
      const date = new Date(dateStr);
      return months[date.getMonth()];
    }
    
    function formatTanggalIndonesia(dateString) {
      if (!dateString) return '';
      
      const bulan = [
        'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
      ];
      
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return dateString;
      
      const tanggal = date.getDate();
      const namaBulan = bulan[date.getMonth()];
      const tahun = date.getFullYear();
      
      return `${tanggal} ${namaBulan} ${tahun}`;
    }
    
    // ===== CALCULATION FUNCTIONS =====
    function generateKodePack(tanggal, mesin) {
      const d = new Date(tanggal);
      const bulan = String(d.getMonth() + 1).padStart(2, '0');
      const tahun = String(d.getFullYear()).slice(-2);
      
      // Add prefix based on machine type
      let prefix = '';
      if (mesin === 'REWIND') prefix = 'R';
      if (mesin === 'SML') prefix = 'S';
      
      return `${prefix}3B${bulan}${tahun}`;
    }
    
    function calculateNetto(thick, width, length, jenis) {
      const faktor = ["VMPET", "PET"].includes(jenis) ? 1.4 : 0.91;
      return ((thick * width * length * faktor) / 1000000).toFixed(2);
    }
    
    function calculatePaperCore(width) {
      return (0.00537 * parseFloat(width || 0) + 0.852).toFixed(2);
    }
    
    // ===== SUB KODE HANDLING =====
    function handleSubKode() {
      const subKodeValue = document.getElementById('subKodeValue');
      const selectedType = document.querySelector('input[name="subKodeType"]:checked').value;
      const numericInput = document.getElementById('subKodeNumeric');
      
      // Show/hide numeric input
      numericInput.style.visibility = selectedType === 'numeric' ? 'visible' : 'hidden';
      numericInput.disabled = selectedType !== 'numeric';
      
      // Set value based on selection
      switch(selectedType) {
        case 'numeric':
          // Pastikan selalu 4 digit, tambahkan leading zeros jika perlu
          subKodeValue.value = numericInput.value.padStart(4, '0') || '0000';
          break;
        case 'reject':
          subKodeValue.value = 'REJECT';
          break;
        case 'hold':
          subKodeValue.value = '0000';
          break;
      }
      
      updateStatusBasedOnSubKode();
    }
    
    function updateStatusBasedOnSubKode() {
      const subKodeValue = document.getElementById('subKodeValue').value;
      const statusField = document.querySelector('input[name="status"]');
      
      if (subKodeValue === 'REJECT') {
        statusField.value = 'REJECT';
      } else if (subKodeValue === '0000') {
        statusField.value = 'HOLD';
      } else {
        statusField.value = 'PASS';
      }
    }
    
    // ===== TYPE CHANGE HANDLER =====
    function handleTypeChange() {
      const typeSelect = document.querySelector('select[name="type"]');
      const odInput = document.getElementById('odInput');
      
      if (typeSelect.value === "METALIZED") {
        odInput.readOnly = false;
        odInput.classList.remove('auto-input');
        odInput.required = true;
        odInput.value = "OD2.4";
      } else {
        odInput.required = false;
        odInput.value = "";
      }
    }
    
    // ===== AUTO FIELD UPDATES =====
    function updateAutoFields() {
      const tglManual = form.tanggalManual.value;
      const tglShift = calculateShiftDate(); // Dapatkan tanggal shift yang dihitung
      const thick = parseFloat(form.thickness.value) || 0;
      const width = parseFloat(form.width.value) || 0;
      const length = parseFloat(form.length.value) || 0;
      const mesin = form.mesin.value;
      
      // Tentukan tanggal yang akan digunakan untuk perhitungan dan tampilan
      // Jika tanggalManual diisi, gunakan tanggalManual, jika tidak, gunakan tglShift
      const finalDate = tglManual || tglShift;

      // Update sub kode first
      handleSubKode();
      
      // Set tanggal shift di form (field 'tanggalShift' auto-input)
      document.getElementById('tanggalShift').value = tglShift; 
       
      // Set tanggal yang akan ditampilkan di form (field 'tanggal' auto-input)
      form.tanggal.value = finalDate;

      // Gunakan finalDate untuk generateKodePack
      form.kodePack.value = generateKodePack(finalDate, mesin);
      form.paperCore.value = calculatePaperCore(width);
      form.netto.value = calculateNetto(thick, width, length, form.jenis.value);
    }
    
    // ===== MODAL FUNCTIONS =====
    function openModal(index = -1) {
      form.reset();
       // Reset tanggal manual
      form.tanggalManual.value = '';
      currentEditIndex = index;
      document.getElementById("modal").style.display = "flex";
      
      // Initialize type and sub kode handling
      handleTypeChange();
      handleSubKode();
      
      if (index >= 0) {
        const data = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");
        const item = data[index];
        
        // Populate form fields
        for (let key in item) {
          if (form[key]) {
            form[key].value = item[key];
          }
        }
        
        // Handle special cases for sub kode
        if (item.subKode === 'REJECT') {
          document.querySelector('input[name="subKodeType"][value="reject"]').checked = true;
        } else if (item.subKode === '0000') {
          document.querySelector('input[name="subKodeType"][value="hold"]').checked = true;
        } else {
          document.querySelector('input[name="subKodeType"][value="numeric"]').checked = true;
          // Pastikan subKodeNumeric diisi dengan angka tanpa leading zero jika itu string '0001' -> '1'
          document.getElementById('subKodeNumeric').value = item.subKode ? parseInt(item.subKode, 10).toString() : '';
        }

        // Jika item.tanggalManual ada, set tanggalManual
        if (item.tanggalManual) {
          form.tanggalManual.value = item.tanggalManual;
        } else {
          form.tanggalManual.value = ''; // Pastikan kosong jika tidak ada
        }
      }
      // Panggil updateAutoFields setelah form diisi (untuk edit) atau direset (untuk tambah)
      updateAutoFields();
    }
    
    function closeModal() {
      document.getElementById("modal").style.display = "none";
      currentEditIndex = -1;
    }
    
    // ===== DATA TABLE FUNCTIONS =====
    // Update the renderTable function
function renderTable(filteredData = null) {
  const allData = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");
  const data = filteredData || allData;
  const tbody = document.getElementById("dataBody");
  tbody.innerHTML = "";

  const totalRows = data.length;
  const totalPages = Math.ceil(totalRows / rowsPerPage);
  const start = (currentPage - 1) * rowsPerPage;
  const end = Math.min(start + rowsPerPage, totalRows);
  const paginatedData = data.slice(start, end);

  // Cari indeks absolut untuk setiap item dalam hasil pencarian
  const absoluteIndices = paginatedData.map(item => 
    allData.findIndex(d => d.uniqId === item.uniqId)
  );

  const duplicateKodePacks = getDuplicateKodePacks(allData);

  paginatedData.forEach((item, index) => {
    const absoluteIndex = absoluteIndices[index];
    const row = document.createElement("tr");
    let machineClass;

    switch(item.mesin) {
      case 'REWIND':
        machineClass = 'machine-rewind';
        break;
      case 'SML':
        machineClass = 'machine-sml';
        break;
      default:
        machineClass = 'machine-slitting';
    }

    const isDuplicate = item.status !== 'HOLD' &&
                        item.status !== 'REJECT' &&
                        duplicateKodePacks.has(item.kodePack + (item.subKode || ''));

    row.innerHTML = `
      <td><input type="checkbox" class="row-check" data-index="${absoluteIndex}" onchange="updateBulkActionsVisibility()"/></td>
      <td>${absoluteIndex + 1}</td>
      <td>${item.uniqId || '-'}</td>
      <td>${formatTanggalIndonesia(item.tanggal)}</td>
      <td><span class="${machineClass}">${item.mesin}</span></td>
      <td>${item.supplier || 'INHOUSE'}</td> 
      <td>${item.spk}</td>
      <td>${item.lot}<text style="color: red;">${item.turunan}</text></td>
      <td>${item.jenis} ${item.kode} ${item.thickness} MC X ${item.width} MM = ${item.length}</td>
      <td ${isDuplicate ? ' style="background-color: red; color: yellow; font-weight: bold;"' : ''}>${item.kodePack}<text ${isDuplicate ? ' style="color: yellow; font-weight: bold;"' : 'style="color: red; font-weight: bold; "'}>${item.subKode}</text></td>
      <td>${getMonthName(item.tanggal)}</td>
      <td>
        <button class="btn btn-primary" onclick="openModal(${absoluteIndex})">Edit</button>
        <button class="btn btn-secondary" onclick="duplicateData(${absoluteIndex})">Duplikat</button>
        <button class="btn btn-danger" onclick="deleteData(${absoluteIndex})">Hapus</button>
      </td>`;
    tbody.appendChild(row);
  });

  updatePaginationControls(totalPages);
}

function updatePaginationControls(totalPages) {
  // Update top pagination
  const topPageNumbers = document.getElementById('topPageNumbers');
  topPageNumbers.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const button = document.createElement('button');
    button.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
    button.textContent = i;
   button.onclick = () => {
  currentPage = i;
  renderTable(currentSearchTerm ? data.filter(item =>
    Object.values(item).join(' ').toLowerCase().includes(currentSearchTerm)
  ) : null);
};
    topPageNumbers.appendChild(button);
  }

  // Update bottom pagination
  const bottomPageNumbers = document.getElementById('bottomPageNumbers');
  bottomPageNumbers.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const button = document.createElement('button');
    button.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
    button.textContent = i;
    button.onclick = () => {
      currentPage = i;
      renderTable(currentSearchTerm ? data.filter(item =>
        Object.values(item).join(' ').toLowerCase().includes(currentSearchTerm)
      ) : null);
    };
    bottomPageNumbers.appendChild(button);
  }
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    renderTable(currentSearchTerm ? JSON.parse(localStorage.getItem(DATA_KEY)).filter(item =>
      Object.values(item).join(' ').toLowerCase().includes(currentSearchTerm)
    ) : null);
  }
}

function nextPage() {
  const allData = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");
  const data = currentSearchTerm ? 
    allData.filter(item => Object.values(item).join(' ').toLowerCase().includes(currentSearchTerm)) : 
    allData;
  
  const totalPages = Math.ceil(data.length / rowsPerPage);
  if (currentPage < totalPages) {
    currentPage++;
    renderTable(currentSearchTerm ? data : null);
  }
}



// ===== STORAGE MONITORING =====
// ===== UPDATE STORAGE USAGE =====
function updateStorageUsage() {
  const used = JSON.stringify(localStorage).length;
  const quota = 5 * 1024 * 1024; // 5MB
  const percent = Math.min((used / quota) * 100, 100);
  const percentStr = percent.toFixed(1) + '%';

  document.getElementById('storagePercent').textContent = percentStr;
  document.getElementById('storageFill').style.width = percentStr;

  if (percent < 70) {
    document.getElementById('storageFill').style.backgroundColor = '#4CAF50';
  } else if (percent < 90) {
    document.getElementById('storageFill').style.backgroundColor = '#FFA726';
  } else {
    document.getElementById('storageFill').style.backgroundColor = '#EF5350';
    if (!document.getElementById('storageWarning')) {
      showStorageFullWarning();
    }
  }
}

function showStorageFullWarning() {
  const warning = document.createElement('div');
  warning.id = 'storageWarning';
  warning.style = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #EF5350;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    animation: fadeIn 0.3s ease-in-out;
    max-width: 400px;
    text-align: center;
  `;
  warning.innerHTML = `
    ⚠️ Penyimpanan hampir penuh.<br/>
    Pertimbangkan ekspor atau migrasi data.
    <button onclick="this.parentElement.remove()" style="
      margin-top: 10px;
      background: white;
      color: #EF5350;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    ">&times;</button>
  `;
  document.body.appendChild(warning);

  setTimeout(() => {
    if (warning.parentNode) warning.remove();
  }, 10000);
}

// Auto-update saat data berubah
function updateLocalStorageAndMonitor() {
  renderTable(); // Pastikan tabel selalu terupdate
  updateStorageUsage();
}
    
    function toggleAll(checkbox) {
      document.querySelectorAll(".row-check").forEach(c => c.checked = checkbox.checked);
    }
    
    function deleteData(index) {
      if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
        const data = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");
        data.splice(index, 1);
        localStorage.setItem(DATA_KEY, JSON.stringify(data));
        updateLocalStorageAndMonitor();;
      }
    }
    
   function duplicateData(index) {
  const data = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");
  const duplicatedItem = { ...data[index] };

  // Tambahkan UNIQ ID baru untuk data duplikat
  duplicatedItem.uniqId = generateUniqID();

  // Gunakan tanggal shift saat ini untuk data duplikat
  duplicatedItem.tanggal = calculateShiftDate();

  // Hapus tanggalManual jika ada di duplikat, agar tidak menimpa tanggal shift
  if (duplicatedItem.tanggalManual) {
    delete duplicatedItem.tanggalManual;
  }

  data.push(duplicatedItem);
  localStorage.setItem(DATA_KEY, JSON.stringify(data));
  updateLocalStorageAndMonitor();
}
    
    // ===== FORM HANDLING =====
    function handleFormSubmit(e) {
  e.preventDefault();
  const data = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");
  const formData = new FormData(form);
  const newData = {};
  
  // Ambil semua data dari form kecuali tanggalManual
  formData.forEach((val, key) => {
    if (key !== 'tanggalManual') {
      newData[key] = val;
    }
  });

  // Tambahkan UNIQ ID jika belum ada
  if (!newData.uniqId) {
    newData.uniqId = generateUniqID(); // Fungsi pembuat UNIQ ID
  }

  // Secara eksplisit tambahkan tanggalManual jika ada nilainya
  if (form.tanggalManual.value) {
    newData.tanggalManual = form.tanggalManual.value;
  } else {
    delete newData.tanggalManual; 
  }

  // Tetapkan tanggal utama data: jika tanggalManual ada, gunakan itu, jika tidak, gunakan tanggalShift
  newData.tanggal = form.tanggalManual.value || form.tanggalShift.value;

  if (currentEditIndex >= 0 && currentEditIndex < data.length) {
    data[currentEditIndex] = newData;
  } else {
    data.push(newData);
  }

  localStorage.setItem(DATA_KEY, JSON.stringify(data));
  closeModal();
  if (currentSearchTerm) {
    const filteredData = data.filter(item => 
      Object.values(item).join(' ').toLowerCase().includes(currentSearchTerm)
    );
    renderTable(filteredData);
  } else {
    renderTable();
  }
  
  showToast("Data berhasil disimpan", "success");
  updateLocalStorageAndMonitor();
  form.reset();
  form.tanggalManual.value = '';
}
    
    // ===== PREVIEW FUNCTIONS =====
    function previewSelected() {
      const data = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");
      const selected = [...document.querySelectorAll(".row-check:checked")].map(cb => data[cb.dataset.index]);
      
      if (selected.length === 0) {
        showToast("Pilih setidaknya satu data untuk dipreview", "warning");
        return;
      }
      
      const container = document.getElementById("printArea");
      container.innerHTML = selected.map(item => createLabelHTML(item)).join("");
      
      // --- Pastikan urutan ini: ---
      // 1. Scroll body ke paling atas
      window.scrollTo(0, 0);

      // 2. Tambahkan kelas no-scroll untuk mengunci body
      document.body.classList.add('no-scroll');

      // 3. Tampilkan modal pratinjau (ini bisa sedikit di-delay jika perlu untuk efek visual)
      document.getElementById('previewModal').style.display = 'flex';
      // --------------------------
    }
    
    function createLabelHTML(item) {
      let machineClass;
      switch(item.mesin) {
        case 'REWIND':
          machineClass = 'machine-rewind';
          break;
        case 'SML':
          machineClass = 'machine-sml';
          break;
        default:
          machineClass = 'machine-slitting';
      }
    
      // Get current date and time
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
      const year = String(now.getFullYear()).slice(-2); // Get last two digits of the year
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const dateTimeString = `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;

      // --- AWAL MODIFIKASI ---
      let firstCellHTML = '';
      if (item.jenisPrint === 'B-GRADE') {
        firstCellHTML = `<td class="B-grade"> B-GRADE </td>`;
      } else if (item.mesin === 'SML') {
        firstCellHTML = `<td class="machine-slitting"> IN LINE SML </td>`;
      } else {
        firstCellHTML = '<td></td>';
      }
      // --- AKHIR MODIFIKASI ---
    
      return `
        <div class="label-preview-content">
          <table class="label-table" style="margin:0; padding:0; font-size:12px;">
            <tr>
              ${firstCellHTML} 
              <td colspan="4" style="padding:2px; text-align:center;">
                <text style="font-family:'Impact', sans-serif; font-size:24px; color:#d61c1c;">PT. SAPTAWARNA CEMERLANG</text><br>
                <text style="font-family:'Open Sans', sans-serif; font-size:10px; color:black;"></text>
              </td>
              <td style="padding:2px; font-size:12px; font-weight:bold;">${formatTanggalIndonesia(item.tanggal)}</td>
              <td style="width:60px; padding:2px; text-align:center;">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data= ${encodeURIComponent(
                  `${item.jenis} ${item.kode} ${item.thickness} MC X ${item.width} MM = ${item.length}|${item.lot}${item.turunan}|${item.kodePack}${item.subKode}`
                )}" style="width:50px; height:auto;" />
              </td>
            </tr>
            <tr>
              <td colspan="5" style="padding:2px; font-weight:bold; font-size:13px;">${item.jenis}(${item.type}) ${item.kode}</td>
              <td style="padding:2px; font-weight:bold; font-size:13px;">${item.spk}</td>
              <td rowspan="7" style="text-align:center; vertical-align:middle; padding:2px;">
                <img src="https://isnanswc.github.io/gambar/${getMonthName(item.tanggal).toLowerCase()}.png" alt="${getMonthName(item.tanggal)}" style="max-height:150px; max-width: 50px;" />
            </tr>
            <tr>
              <td style="padding:2px; font-size:11px;"><strong>Thick</strong></td>
              <td style="padding:0.5px; font-size:16px;"><strong>${item.thickness}</strong></td>
              <td style="padding:2px; font-size:11px;"><strong>Netto</strong></td>
              <td style="padding:2px; font-size:16px;"><strong>${item.netto}</strong></td>
              <td style="padding:2px; font-size:11px;"><strong>Treatment</strong></td>
              <td style="padding:2px; color:red; font-weight:bold; font-size:11px;">${item.treatment}</td>
            </tr>
            <tr>
              <td style="padding:2px; font-size:11px;"><strong>Width</strong></td>
              <td style="padding:0.5px; font-size:16px;"><strong>${item.width}</strong></td>
              <td style="padding:2px; font-size:11px;"><strong>Paper Core</strong></td>
              <td style="padding:2px; font-size:16px;">${item.paperCore}</td>
              <td style="padding:2px; font-size:11px;"><strong>OD</strong></td>
              <td style="padding:2px; color:red; font-weight:bold; font-size:11px;">${item.od}</td>
            </tr>
            <tr>
              <td style="padding:2px; font-size:11px;"><strong>Length</strong></td>
              <td style="padding:0.5px; font-size:16px;"><strong>${item.length}</strong></td>
              <td style="padding:2px; font-size:11px;"><strong>Joint</strong></td>
              <td style="padding:2px; font-size:16px;">${item.joint}</td>
              <td style="padding:2px; font-size:11px;"><strong>Meter</strong></td>
              <td style="padding:2px; font-size:16px;">${item.meter}</td>
            </tr>
            <tr>
              <td style="padding:2px; background-color:#f0f0f0; font-size:11px;"><strong>${item.supplier || 'INHOUSE'}</strong></td>
              <td colspan="4" style="padding:2px; font-size:18px; font-weight:bold; text-align:center;">${item.lot}</td>
              <td style="padding:2px; font-size:14px; font-weight:bold; text-align:center;">${item.turunan}</td>
            </tr>
            <tr>
              <td style="padding:2px; font-size:11px;"><strong>Code Pack:</strong></td>
              <td colspan="3" style="padding:2px; font-size:16px;"><strong>${item.kodePack}<span style="color:red;">${item.subKode}</span></strong></td>
              <td style="padding:2px; font-size:11px;"><strong>STATUS</strong></td>
              <td class="${item.status === 'HOLD' ? 'label-fail' : item.status === 'REJECT' ? 'label-reject' : 'label-pass'}" style="font-size:11px;">
                ${item.status}
              </td>
            </tr>
            <tr>
              <td style="padding:2px; font-size:11px;"><strong>Ket:</strong></td>
              <td colspan="5" style="padding:2px; font-size:11px;">${item.keterangan || '-'}</td>
            </tr>
          </table>
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <strong><text style="font-size: 9px">${item.uniqId}</text></strong>
            <span style="font-size: 9px;">${dateTimeString}</span>
          </div>
        </div>`;
    }
    
    function closePreview() {
      document.getElementById("previewModal").style.display = "none";
      document.body.classList.remove('no-scroll'); // --- TAMBAHKAN KODE INI ---

    }
    
    // ===== EXPORT FUNCTIONS =====
    function exportToExcel() {
      const data = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");

      if (data.length === 0) {
        showToast("Tidak ada data untuk diexport!","error");
        return;
      }

      const worksheetData = data.map((item, index) => ({
        No: index + 1,
        'UNIQ ID': item.uniqId,
        Tanggal:new Date(item.tanggal).toLocaleDateString('en-GB'),
        Mesin: item.mesin,
        Supplier: item.supplier || 'INHOUSE',
        SPK: item.spk,
        'No Lot': item.lot,
        Turunan: item.turunan,
        Jenis: item.jenis,
        Type: item.type,
        OD: item.od,
        Treatment: item.treatment,
        Thickness: item.thickness,
        Width: item.width,
        Length: item.length,
        Joint: item.joint,
        Meter: item.meter,
        Kode: item.kode,
        'Kode Pack': item.kodePack,
        'Sub Kode': item.subKode,
        Bulan: getMonthName(new Date(item.tanggal)),
        Status: item.status,
        Netto: item.netto,
        'Paper Core': item.paperCore,
        Keterangan: item.keterangan
      }));

      const ws = XLSX.utils.json_to_sheet(worksheetData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data Label");
      XLSX.writeFile(wb, `LabelData_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
    
    // ===== UTILITY FUNCTIONS =====
    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
        button.innerHTML = '<span style="visibility: hidden;">' + button.textContent + '</span>';
      } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
        button.innerHTML = button.textContent;
      }
    }

    // ===== FUNGSI TANGGAL SHIFT =====
    function calculateShiftDate() {
      const now = new Date(); // Objek Date di zona waktu lokal
      const currentHour = now.getHours();

      // Buat objek Date baru yang akan kita modifikasi
      // Penting untuk membuat salinan, bukan mengubah 'now' secara langsung jika 'now' digunakan di tempat lain
      const shiftDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());

      // Jika jam saat ini kurang dari 7 pagi, itu adalah shift malam hari sebelumnya
      if (currentHour < 7) {
        // Kurangi satu hari dari tanggal *lokal*
        shiftDate.setDate(shiftDate.getDate() - 1);
      }

      // Format tanggal ke YYYY-MM-DD menggunakan metode tanggal lokal
      const year = shiftDate.getFullYear();
      const month = (shiftDate.getMonth() + 1).toString().padStart(2, '0'); // getMonth() is 0-indexed
      const day = shiftDate.getDate().toString().padStart(2, '0');

      return `${year}-${month}-${day}`;
    }

    // Search function
    let currentSearchTerm = '';

   function searchData() {
  const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
  currentSearchTerm = searchTerm;
  
  if (!searchTerm) {
    currentPage = 1;
    renderTable();
    return;
  }

  const data = JSON.parse(localStorage.getItem(DATA_KEY) || []);
  const filteredData = data.filter(item => {
    // Cari di semua field yang relevan
    const searchFields = [
      item.supplier || '',
      item.spk,
      item.lot,
      item.turunan,
      item.jenis,
      item.kode,
      item.kodePack,
      item.subKode,
      formatTanggalIndonesia(item.tanggal),
      getMonthName(item.tanggal)
    ].join(' ').toLowerCase();
    
    return searchFields.includes(searchTerm);
  });

  currentPage = 1;
  renderTable(filteredData);
}

    function deleteSelected() {
      const checkboxes = document.querySelectorAll('.row-check:checked');
      if (checkboxes.length === 0) return;
      
      if (confirm(`Apakah Anda yakin ingin menghapus ${checkboxes.length} data terpilih?`)) {
        const data = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");
        const indexesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index)).sort((a,b) => b - a);
        
        indexesToDelete.forEach(index => {
          data.splice(index, 1);
        });
        
        localStorage.setItem(DATA_KEY, JSON.stringify(data));
        updateLocalStorageAndMonitor();;
        updateBulkActionsVisibility();
      }
    }

    // Update bulk actions visibility based on checked items
    function updateBulkActionsVisibility() {
      const checkboxes = document.querySelectorAll('.row-check:checked');
      const bulkActions = document.getElementById('bulkActions');
      
      if (checkboxes.length > 0) {
        bulkActions.classList.add('visible');
      } else {
        bulkActions.classList.remove('visible');
      }
    }

    // Modify the toggleAll function to update visibility
    function toggleAll(checkbox) {
      document.querySelectorAll(".row-check").forEach(c => c.checked = checkbox.checked);
      updateBulkActionsVisibility();
    }

    // Add this function to check for duplicate kodePack
    function getDuplicateKodePacks(data) {
      const kodePackCounts = {};
      const duplicates = new Set();
      
      data.forEach(item => {
        if (item.status !== 'HOLD' && item.status !== 'REJECT') {
          const key = item.kodePack + (item.subKode || '');
          kodePackCounts[key] = (kodePackCounts[key] || 0) + 1;
          if (kodePackCounts[key] > 1) {
            duplicates.add(key);
          }
        }
      });
      
      return duplicates;
    }

    function showDeleteAllModal() {
      document.getElementById("deletePasswordInput").value = '';
      document.getElementById("deleteAllModal").style.display = "flex";
    }

    function hideDeleteAllModal() {
      document.getElementById("deleteAllModal").style.display = "none";
    }

    function confirmDeleteAll() {
      const enteredPassword = document.getElementById("deletePasswordInput").value;
      const correctPassword = "RIKE RIDHO";

      if (enteredPassword === correctPassword) {
        localStorage.removeItem(DATA_KEY);
        updateLocalStorageAndMonitor();
        hideDeleteAllModal();
        showToast("Semua data berhasil dihapus.","success");
      } else {
        showToast("Password salah! Penghapusan dibatalkan.","error");
      }
    }

    // Fungsi untuk menampilkan Toast Notification
    function showToast(message, type = 'success') {
      let backgroundColor;
      let textColor = '#fff';

      switch (type) {
        case 'success':
          backgroundColor = 'linear-gradient(to right, #5cb85c, #4CAF50)'; // Green
          break;
        case 'error':
          backgroundColor = 'linear-gradient(to right, #d9534f, #f44336)'; // Red
          break;
        case 'info':
          backgroundColor = 'linear-gradient(to right, #5bc0de, #2196F3)'; // Blue
          break;
        case 'warning':
          backgroundColor = 'linear-gradient(to right, #f0ad4e, #FFC107)'; // Orange
          break;
        default:
          backgroundColor = 'linear-gradient(to right, #5cb85c, #4CAF50)';
      }

      Toastify({
        text: message,
        duration: 3000, // Durasi notifikasi dalam milidetik (3 detik)
        close: true, // Tampilkan tombol close
        gravity: "top", // `top` or `bottom`
        position: "right", // `left`, `center` or `right`
        stopOnFocus: true, // Berhenti menghitung mundur durasi saat fokus di notifikasi
        style: {
          background: backgroundColor,
          color: textColor,
          borderRadius: "5px",
          boxShadow: "0 4px 8px rgba(0,0,0,0.2)"
        },
        onClick: function(){} // Callback setelah notifikasi diklik
      }).showToast();
    }
  </script>
<div class="modal" id="deleteAllModal" style="display: none;">
  <div class="modal-content" style="max-width: 400px; padding: 20px;">
    <h3>Konfirmasi Hapus Semua Data</h3>
    <p>Masukkan password untuk melanjutkan:</p>
    <input type="password" id="deletePasswordInput" placeholder="Masukkan password" style="width: 100%; padding: 8px; margin-top: 10px;" />
    <div style="text-align: right; margin-top: 15px;">
      <button class="btn btn-secondary" onclick="hideDeleteAllModal()" style="margin-right: 10px;">Batal</button>
      <button class="btn btn-danger" onclick="confirmDeleteAll()">Hapus Semua</button>
    </div>
  </div>
</div>
</body>
</html>
