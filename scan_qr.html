<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Scanner App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }

    .btn {
      padding: 8px 12px;
      cursor: pointer;
      margin: 5px;
      border: none;
      border-radius: 4px;
    }

    .scan-btn { background: #007bff; color: white; }
    .export-btn { background: #28a745; color: white; }

    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 320px;
      position: relative;
    }

    video {
      width: 100%;
      height: auto;
    }

    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-weight: bold;
      cursor: pointer;
      font-size: 18px;
    }

    .notification {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    .show {
      opacity: 1;
    }

    @media (max-width: 480px) {
      .modal-content {
        width: 90%;
      }
    }
  </style>
</head>
<body>

<h1>QR Code Scanner</h1>
<button class="btn scan-btn" onclick="openModal()">Scan QR</button>
<button class="btn export-btn" onclick="exportToCSV()">Export to CSV</button>
<button onclick="restartCamera()">Restart Kamera</button>
<table id="dataTable">
  <thead>
    <tr>
      <th>Dimensi</th>
      <th>Nomor Lot</th>
      <th>Kode Pack</th>
      <th>Aksi</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal" id="qrModal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <video id="preview"></video>
    <p id="notifCameraStatus">Status kamera: menunggu...</p>
    <p id="notifScanResult">Hasil scan: -</p>
  </div>
</div>

<!-- Notification -->
<div class="notification" id="floatingNotif"></div>

<script src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script> 
<script>
  const modal = document.getElementById('qrModal');
  const preview = document.getElementById('preview');
  const notifEl = document.getElementById('floatingNotif');
  const cameraStatus = document.getElementById('notifCameraStatus');
  const scanResult = document.getElementById('notifScanResult');
  const dataTable = document.querySelector('#dataTable tbody');

  let scanner;

  function showNotification(message, duration = 2000) {
    notifEl.textContent = message;
    notifEl.classList.add('show');
    setTimeout(() => {
      notifEl.classList.remove('show');
    }, duration);
  }

  function vibrate(pattern) {
    if ("vibrate" in navigator) {
      navigator.vibrate(pattern);
    }
  }

  function openModal() {
    modal.style.display = 'flex';
    startScanner();
  }

  function closeModal() {
    modal.style.display = 'none';
    if (scanner) scanner.stop();
  }

  function startScanner() {
    navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => {
    console.log("Kamera tersedia");
    stream.getTracks().forEach(track => track.stop());
  })
  .catch(err => {
    console.error("Kamera tidak tersedia:", err);
    alert("âš ï¸ Kamera tidak dapat diakses. Pastikan izin diberikan.");
  });
  scanner = new ZXing.BrowserQRCodeReader();

  // Delay sedikit agar modal dan video sudah siap
  setTimeout(() => {
    cameraStatus.textContent = "Status kamera: mencoba mengaktifkan...";
    vibrate([100]);

    scanner.decodeFromVideoDevice(null, preview, (result, err) => {
      if (result) {
        const text = result.text;
        const [dimensi, nomorLot, kodePack] = text.split('|');
        if (dimensi && nomorLot && kodePack) {
          const row = dataTable.insertRow();
          row.innerHTML = `
            <td>${dimensi}</td>
            <td>${nomorLot}</td>
            <td>${kodePack}</td>
            <td><button onclick="deleteRow(this)">Hapus</button></td>
          `;
          scanResult.textContent = "Hasil scan: berhasil";
          showNotification("âœ… Berhasil di-scan", 1500);
          vibrate([0, 100, 50, 100]);
          closeModal();
        } else {
          scanResult.textContent = "Format salah!";
          showNotification("âš ï¸ Format QR tidak sesuai", 2000);
          vibrate([0, 200, 100, 200]);
        }
      }

      if (err && !(err instanceof ZXing.NotFoundException)) {
        console.error(err);
        cameraStatus.textContent = "Status kamera: error!";
        showNotification("ðŸ”´ Kamera gagal diaktifkan", 2000);
        vibrate([0, 300, 200, 300]);

        // Menampilkan detail error tambahan
        console.warn("Detail Error:", err.message || err);

        // Fallback: coba daftar perangkat kamera manual
        scanner.getVideoInputDevices()
          .then(devices => {
            if (devices.length === 0) {
              console.warn("Tidak ada perangkat kamera tersedia.");
              showNotification("ðŸš« Tidak ada kamera tersedia.", 3000);
            } else {
              console.log("Daftar kamera:", devices);
              scanner.decodeFromVideoDevice(devices[0].deviceId, preview, () => {});
            }
          });
      }
    });
  }, 500); // delay 0.5 detik
}

  function deleteRow(btn) {
    const row = btn.parentNode.parentNode;
    dataTable.deleteRow(row.rowIndex - 1); // karena header ada di index 0
  }

  function exportToCSV() {
    let csv = 'Dimensi,Nomor Lot,Kode Pack\n';
    Array.from(dataTable.rows).forEach(row => {
      const cells = row.querySelectorAll('td');
      csv += `${cells[0].textContent},${cells[1].textContent},${cells[2].textContent}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'data_scan.csv';
    a.click();
    URL.revokeObjectURL(url);
    showNotification("ðŸ“ Data diekspor ke CSV", 1500);
  }
  function restartCamera() {
  closeModal(); // pastikan modal tertutup
  setTimeout(() => {
    startScanner(); // mulai ulang scan
  }, 1000);
}
</script>

</body>
</html>
