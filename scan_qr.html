<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scanner QRCode - Versi Notifikasi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    #interactive.viewport {
      width: 100%;
      max-width: 400px;
      margin: auto;
      border: 2px solid #ccc;
      border-radius: 8px;
      overflow: hidden;
    }

    video {
      width: 100%;
      display: block;
    }

    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      border: 1px solid #aaa;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #eee;
    }

    /* Toast Notification */
    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 4px;
      padding: 12px;
      position: fixed;
      z-index: 9999;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.5s, visibility 0.5s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    #toast.show {
      visibility: visible;
      opacity: 1;
    }

    @media screen and (max-width: 600px) {
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<div id="toast"></div>

<div class="container">
  <h1>Scanner QR Code</h1>

  <div class="controls">
    <button onclick="startCamera()">Start Kamera</button>
    <button onclick="stopCamera()">Stop Kamera</button>
    <button onclick="exportToExcel()">Export ke Excel</button>
    <button onclick="clearData()">Hapus Semua Data</button>
  </div>

  <div id="interactive" class="viewport"></div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Ukuran</th>
        <th>No Lot</th>
        <th>Kode Pack</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data akan ditambahkan di sini -->
    </tbody>
  </table>
</div>

<!-- Library Quagga2 untuk scanning -->
<script src="https://unpkg.com/ @ericblade/quagga2@1.2.6/dist/quagga.min.js"></script>

<!-- Library SheetJS untuk export Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js "></script>

<script>
  let isScanning = true;

  const config = {
    inputStream: {
      type: "LiveStream",
      target: document.querySelector('#interactive'),
      constraints: {
        facingMode: "environment"
      },
    },
    decoder: {
      readers: ["qrcode_reader"]
    }
  };

  function showToast(message, bgColor = "#333") {
    const toast = document.getElementById("toast");
    toast.innerHTML = message;
    toast.style.backgroundColor = bgColor;
    toast.className = "show";
    setTimeout(() => { toast.className = ""; }, 3000);
  }

  function startCamera() {
    if (!Quagga.initialized) {
      Quagga.init(config, function(err) {
        if (err) {
          console.log(err);
          showToast("ðŸ”´ Gagal mengakses kamera. Izinkan akses kamera.", "#dc3545");
          return;
        }
        Quagga.start();
        isScanning = true;
        showToast("ðŸŸ¢ Kamera berhasil diaktifkan", "#28a745");
      });
    } else {
      Quagga.start();
      isScanning = true;
      showToast("ðŸŸ¢ Kamera berhasil diaktifkan", "#28a745");
    }
  }

  function stopCamera() {
    Quagga.stop();
    isScanning = false;
    showToast("âšª Kamera dinonaktifkan", "#6c757d");
  }

  // Muat data dari localStorage saat halaman dibuka
  window.onload = () => {
    loadDataFromLocalStorage();
    startCamera(); // Mulai otomatis
  };

  Quagga.onProcessed(function(result) {
    if (isScanning && result && result.codeResult) {
      showToast("ðŸ”µ Kamera sedang aktif...", "#007bff");
    }
  });

  Quagga.onDetected(data => {
    if (!isScanning) return;

    const rawText = data.codeResult.code;
    const parts = rawText.split('|');

    if (parts.length === 3) {
      const ukuran = parts[0];
      const noLot = parts[1];
      const kodePack = parts[2];

      const row = `<tr><td>${ukuran}</td><td>${noLot}</td><td>${kodePack}</td></tr>`;
      document.querySelector("#dataTable tbody").innerHTML += row;

      saveDataToLocalStorage({ ukuran, noLot, kodePack });

      // Hentikan sejenak agar tidak terdeteksi berulang
      Quagga.stop();
      setTimeout(() => Quagga.start(), 1500);
    } else {
      alert("Format QR salah. Harus ada 3 bagian dipisah dengan |");
    }
  });

  function saveDataToLocalStorage() {
    const rows = document.querySelectorAll("#dataTable tbody tr");
    const data = [];

    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      data.push({
        Ukuran: cells[0].innerText,
        "No Lot": cells[1].innerText,
        "Kode Pack": cells[2].innerText
      });
    });

    localStorage.setItem("qr_data", JSON.stringify(data));
  }

  function loadDataFromLocalStorage() {
    const data = JSON.parse(localStorage.getItem("qr_data")) || [];
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    data.forEach(item => {
      const row = `
        <tr>
          <td>${item.Ukuran}</td>
          <td>${item["No Lot"]}</td>
          <td>${item["Kode Pack"]}</td>
        </tr>`;
      tbody.innerHTML += row;
    });
  }

  function exportToExcel() {
    const wb = XLSX.utils.table_to_book(document.getElementById('dataTable'));
    XLSX.writeFile(wb, 'data_qr_code.xlsx');
  }

  function clearData() {
    if (confirm("Yakin ingin hapus semua data?")) {
      document.querySelector("#dataTable tbody").innerHTML = "";
      localStorage.removeItem("qr_data");
    }
  }
</script>

</body>
</html>
