<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>QR Scanner Android</title>
    <style>
        :root {
            --primary: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196F3;
        }
        * { box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 15px;
        }
        h1, h2 { text-align: center; color: #333; }
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover { background-color: #388E3C; }
        #result {
            margin: 15px 0;
            padding: 12px;
            background-color: #e8f5e9;
            border-left: 4px solid var(--primary);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: var(--primary); color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            width: 95%;
            max-width: 500px;
            position: relative;
        }
        #qr-video {
            width: 100%;
            border-radius: 8px;
            background-color: black;
        }
        #scan-region {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 70%; height: 70%;
            border: 3px dashed white;
        }
        .notification {
            position: fixed;
            bottom: 20px; right: 20px;
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
            border-radius: 5px;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .notification.show {
            opacity: 1;
        }
        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>QR Code Scanner Android</h1>
    <div id="result">Arahkan kamera ke QR code dengan format: ukuran|no_lot|kode_pack</div>
    <div class="button-container">
        <button id="open-modal-btn">Buka Scanner</button>
        <button id="clear-btn">Hapus Data</button>
        <button id="export-btn">Export Excel</button>
    </div>
    <table id="data-table">
        <thead>
            <tr><th>No.</th><th>Ukuran</th><th>No. Lot</th><th>Kode Pack</th><th>Waktu Scan</th><th>Aksi</th></tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal" id="scanner-modal">
    <div class="modal-content">
        <video id="qr-video" playsinline></video>
        <div id="scan-region"></div>
    </div>
    <div class="button-container" style="margin-top:20px">
        <button id="start-btn">Mulai Scan</button>
        <button id="stop-btn" disabled>Stop Scan</button>
    </div>
</div>

<!-- Notifikasi -->
<div class="notification" id="notification">
    <div class="notification-title" id="notification-title"></div>
    <div class="notification-content" id="notification-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr @latest/dist/jsQR.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js "></script>
<script>
    let videoStream = null;
    let scanInterval = null;
    let scannedData = [];
    let isScanning = false;

    const videoElement = document.getElementById('qr-video');
    const resultElement = document.getElementById('result');
    const tableBody = document.getElementById('table-body');
    const scannerModal = document.getElementById('scanner-modal');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const notification = document.getElementById('notification');
    const notifTitle = document.getElementById('notification-title');
    const notifContent = document.getElementById('notification-content');

    // Load data saat halaman dimuat
    document.addEventListener('DOMContentLoaded', () => {
        loadFromStorage();
        renderTable();
    });

    // Event Listeners
    document.getElementById('open-modal-btn').addEventListener('click', openScannerModal);
    document.getElementById('start-btn').addEventListener('click', startScanning);
    document.getElementById('stop-btn').addEventListener('click', stopScanning);
    document.getElementById('clear-btn').addEventListener('click', clearAllData);
    document.getElementById('export-btn').addEventListener('click', exportToExcel);

    function showNotification(title, content, type = 'success') {
        notifTitle.textContent = title;
        notifContent.innerHTML = content;
        notification.className = `notification ${type} show`;
        setTimeout(() => notification.classList.remove('show'), 4000);
        resultElement.innerHTML = `<strong>${title}</strong><br>${content}`;
    }

    async function startScanning() {
        if (isScanning) return;
        try {
            const constraints = { video: { facingMode: "environment" } };
            videoStream = await navigator.mediaDevices.getUserMedia(constraints);
            videoElement.srcObject = videoStream;
            await videoElement.play();
            isScanning = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            scanInterval = setInterval(scanWithjsQR, 300);
        } catch (err) {
            showNotification("Error", "Izin kamera ditolak atau tidak tersedia", "error");
        }
    }

    function stopScanning() {
        clearInterval(scanInterval);
        if (videoStream) {
            videoStream.getTracks().forEach(t => t.stop());
            videoStream = null;
            videoElement.srcObject = null;
        }
        isScanning = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
    }

    function scanWithjsQR() {
    if (!isScanning || !videoElement.srcObject) {
        console.warn("Scanner tidak aktif atau video tidak tersedia");
        return;
    }

    const canvas = document.createElement('canvas');
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;

    if (canvas.width === 0 || canvas.height === 0) {
        console.warn("Dimensi video tidak valid");
        return;
    }

    const ctx = canvas.getContext('2d');
    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    const code = jsQR(imageData.data, canvas.width, canvas.height, { inversionAttempts: "dontInvert" });

    if (code) {
        console.log("QR Code ditemukan:", code.data);
        processScannedData(code.data);
    } else {
        // console.log("Belum ada QR code terdeteksi");
    }
}

    function processScannedData(data) {
        try {
            if (typeof data !== 'string' || data.trim() === '') {
                throw new Error("Data QR tidak valid");
            }

            // Bersihkan karakter aneh
            const cleaned = data.replace(/[^\x20-\x7E]/g, '').trim();
            const parts = cleaned.split('|').map(p => p.trim());

            if (parts.length !== 3) {
                throw new Error(`Format harus: ukuran|no_lot|kode_pack. Diterima: ${cleaned}`);
            }

            const [ukuran, noLot, kodePack] = parts;

            if (!ukuran || !noLot || !kodePack) {
                throw new Error("Semua field harus diisi");
            }

            if (isDuplicate(noLot, kodePack)) {
                throw new Error("Data ini sudah pernah discan");
            }

            const waktuScan = new Date().toLocaleString();
            addToTable(ukuran, noLot, kodePack, waktuScan);
            saveToStorage(ukuran, noLot, kodePack, waktuScan);
            showNotification("Berhasil", `Ukuran: ${ukuran}<br>No. Lot: ${noLot}`, "success");

        } catch (err) {
            console.error("Error:", err.message);
            showNotification("Gagal", err.message, "error");
        }
    }

    function isDuplicate(noLot, kodePack) {
        return scannedData.some(item => item.noLot === noLot && item.kodePack === kodePack);
    }

    function addToTable(ukuran, noLot, kodePack, waktuScan) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${scannedData.length + 1}</td>
            <td>${escapeHtml(ukuran)}</td>
            <td>${escapeHtml(noLot)}</td>
            <td>${escapeHtml(kodePack)}</td>
            <td>${waktuScan}</td>
            <td><button onclick="deleteRow('${noLot}', '${kodePack}')">Hapus</button></td>`;
        tableBody.appendChild(row);
    }

    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, m => ({
            '&': '&amp;', '<': '<', '>': '>',
            '"': '&quot;', "'": '&#39;'
        })[m]);
    }

    function deleteRow(noLot, kodePack) {
        if (!confirm(`Hapus data: No. Lot=${noLot}, Kode Pack=${kodePack}?`)) return;
        scannedData = scannedData.filter(d => !(d.noLot === noLot && d.kodePack === kodePack));
        localStorage.setItem('qrScans', JSON.stringify(scannedData));
        renderTable();
    }

    function clearAllData() {
        if (!confirm("Yakin ingin hapus semua data?")) return;
        scannedData = [];
        localStorage.removeItem('qrScans');
        renderTable();
        showNotification("Info", "Semua data berhasil dihapus", "info");
    }

    function saveToStorage(ukuran, noLot, kodePack, waktuScan) {
        const data = { ukuran, noLot, kodePack, waktuScan };
        scannedData.unshift(data);
        localStorage.setItem('qrScans', JSON.stringify(scannedData));
    }

    function loadFromStorage() {
        const saved = localStorage.getItem('qrScans');
        if (saved) {
            try {
                scannedData = JSON.parse(saved);
            } catch {
                scannedData = [];
            }
        }
    }

    function renderTable() {
        tableBody.innerHTML = '';
        if (scannedData.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="6" style="text-align:center">Tidak ada data</td>`;
            tableBody.appendChild(row);
            return;
        }

        scannedData.forEach((d, i) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${i+1}</td>
                <td>${escapeHtml(d.ukuran)}</td>
                <td>${escapeHtml(d.noLot)}</td>
                <td>${escapeHtml(d.kodePack)}</td>
                <td>${d.waktuScan}</td>
                <td><button onclick="deleteRow('${d.noLot}', '${d.kodePack}')">Hapus</button></td>`;
            tableBody.appendChild(row);
        });
    }

    function exportToExcel() {
        if (scannedData.length === 0) {
            showNotification("Export Gagal", "Tidak ada data untuk di-export", "error");
            return;
        }

        const ws_data = [
            ['No.', 'Ukuran', 'No. Lot', 'Kode Pack', 'Waktu'],
            ...scannedData.map((d, i) => [i+1, d.ukuran, d.noLot, d.kodePack, d.waktuScan])
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Data QR");
        XLSX.writeFile(wb, `QR_Scans_${new Date().toISOString().slice(0,10)}.xlsx`);
        showNotification("Export Berhasil", "Data berhasil di-export", "success");
    }

    function openScannerModal() {
        scannerModal.style.display = 'flex';
    }

    window.onclick = e => {
        if (e.target === scannerModal) scannerModal.style.display = 'none';
    };

    window.deleteRow = deleteRow;
</script>
</body>
</html>
