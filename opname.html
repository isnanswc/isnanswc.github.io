<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Stok Opname Modern</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb; /* Blue-700 */
            --primary-hover: #1d4ed8; /* Blue-800 */
            --secondary-color: #eef2f6; /* Slate-100 */
            --border-color: #cbd5e1; /* Slate-300 */
            --text-primary: #1e293b; /* Slate-900 */
            --text-secondary: #64748b; /* Slate-500 */
            --background-color: #f8fafc; /* Slate-50 */
            --card-background: #ffffff;
            --success-color: #16a34a; /* Green-700 */
            --danger-color: #dc2626; /* Red-600 */
            --warning-color: #f59e0b; /* Amber-500 */
            --light-blue: #eff6ff; /* Blue-50 */
            --subtle-gray: #f1f5f9; /* Slate-100 for a less contrasting background */
            --light-border: #e2e8f0; /* Lighter border for tables */
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            margin: 0;
            line-height: 1.6;
            font-size: 15px;
            display: flex; 
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
            flex-grow: 1; 
        }

        .view {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .view.active {
            display: block;
            opacity: 1;
        }

        .card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        h1, h2, h3 {
            margin-top: 0;
            line-height: 1.3;
            color: var(--text-primary);
        }
        h1 {
            font-size: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        input[type="text"], input[type="number"], input[type="file"], select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.95rem;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            outline: none;
        }
        input[type="file"] {
            padding: 0.5rem 0.75rem; 
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary {
            background-color: var(--secondary-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        button.secondary:hover {
            background-color: #e2e8f0;
        }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #ef4444; }
        button.edit { background-color: var(--warning-color); }
        button.edit:hover { background-color: #d97706; }
        button.small-btn { padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 0.375rem; }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }


        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .header-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .header-controls label {
            font-weight: 600;
            color: var(--text-primary);
        }
        .header-controls select {
            width: auto; 
            min-width: 120px;
            padding: 0.5rem 0.75rem;
        }

        .hidden { display: none !important; }

        /* --- Opname List for Grouped View --- */
        .opname-group {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; 
            margin-bottom: 0.75rem;
            background-color: var(--card-background);
            overflow: hidden; 
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); 
        }

        .opname-group-header {
            display: flex;
            flex-direction: column; 
            padding: 0.8rem 1.2rem; 
            background-color: var(--secondary-color);
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            font-size: 1.15rem; 
            cursor: pointer; 
            user-select: none;
            transition: background-color 0.2s ease;
        }
        .opname-group-header:hover {
            background-color: #e2e8f0;
        }
        .opname-group-header .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .opname-group-header .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .opname-group-header .toggle-icon {
            margin-left: 0.75rem;
            transition: transform 0.2s ease-in-out;
            font-size: 0.9em;
        }
        .opname-group-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .physical-count-form-header {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.8rem; 
            width: 100%; 
        }
        .physical-count-form-header input {
            flex: 1;
            padding: 0.4rem 0.6rem; 
            font-size: 0.85rem;
            min-width: 80px; 
        }
        .physical-count-form-header button {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            flex-shrink: 0; 
        }


        .opname-group-content {
            padding: 0.75rem 1.2rem 0; 
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            box-sizing: content-box; 
        }
        .opname-group-content.expanded {
            max-height: 1000px; 
            opacity: 1;
            padding-bottom: 1rem; 
        }

        .opname-item-detail {
            display: grid;
            grid-template-columns: 2fr 3fr; 
            gap: 0.75rem;
            align-items: flex-start;
            padding: 0.75rem 0; 
            border-top: 1px dashed var(--border-color); 
        }
        .opname-item-detail:first-of-type { border-top: none; } 
        
        .item-sys-detail-info {
            font-size: 0.9em; 
            color: var(--text-secondary);
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .item-sys-detail-info strong {
            color: var(--text-primary);
        }
        .item-sys-detail-info .action-buttons {
            display: inline-flex; 
            gap: 0.3rem; 
            margin-left: 0.5rem;
        }

        .physical-locations ul {
            margin: 0.5rem 0 0;
            padding-left: 1rem;
            font-size: 0.85rem;
            color: #334155;
            list-style: disc;
        }
        .physical-locations li {
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }
        .physical-locations li button { margin-left: 0.5rem; }

        /* --- Sticky Search & Pagination --- */
        .sticky-controls {
            position: sticky;
            top: 0; 
            background-color: var(--background-color);
            padding: 1rem 0;
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem; 
        }
        .pagination-controls button {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .pagination-controls button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .pagination-controls span {
            font-weight: 600;
            color: var(--text-primary);
        }

        .opname-list-scroll-area {
            max-height: calc(100vh - 350px); 
            overflow-y: auto;
            padding-right: 0.5rem; 
        }

        /* --- Floating Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none;
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-content {
            background: white; padding: 1.5rem; border-radius: 0.75rem; width: 90%; max-width: 550px;
            position: relative; box-shadow: 0 15px 30px -5px rgb(0 0 0 / 0.2), 0 8px 10px -6px rgb(0 0 0 / 0.2);
            transform: translateY(-20px); transition: transform 0.3s ease-out;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }
        .modal-close-btn { 
            position: absolute; top: 0.75rem; right: 0.75rem; 
            background: none; border: none; font-size: 1.75rem; cursor: pointer; color: #9ca3af; 
            line-height: 1; padding: 0; width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close-btn:hover { background-color: var(--secondary-color); color: var(--text-primary); }
        .modal-content form { display: flex; flex-direction: column; align-items: stretch; gap: 0.9rem; }
        .modal-content form label { font-weight: 500; margin-bottom: 0.2rem; display: block; font-size: 0.95rem; }
        .modal-content button[type="submit"] { margin-top: 1rem; }
        
        /* --- Tables --- */
        .table-wrapper { overflow-x: auto; margin-top: 1.5rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { border: 1px solid var(--border-color); padding: 0.75rem 1rem; text-align: left; }
        th { background-color: var(--secondary-color); font-weight: 600; color: var(--text-primary); }
        tbody tr:nth-child(even) { background-color: var(--light-blue); } 
        .selisih.positive { color: var(--success-color); font-weight: 600; }
        .selisih.negative { color: var(--danger-color); font-weight: 600; }

        /* Summary Tables specific styling */
        .summary-group-header {
            background-color: var(--subtle-gray); /* Softer background for group headers */
            color: var(--text-primary); /* Darker text for readability */
            font-weight: 700;
        }
        .summary-group-header td {
            border-bottom: none; /* No border below group header for cleaner look */
        }
        .summary-group-detail {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .summary-group-detail ul {
            margin: 0.25rem 0 0; /* Reduced margin */
            padding-left: 1.25rem;
            list-style: disc;
        }
        .summary-group-detail li {
            margin-bottom: 0.1rem; /* Reduced margin */
            line-height: 1.4; /* Better line height for list items */
        }
        td.details-cell ul {
            margin: 0; padding-left: 1.2rem;
            list-style: disc;
        }
        td.details-cell li {
            margin-bottom: 0.2rem;
            font-size: 0.9em; 
        }

        .batch-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 1rem 1.25rem; border: 1px solid var(--border-color); border-radius: 0.5rem;
            margin-bottom: 0.75rem; cursor: pointer; transition: background-color 0.2s, transform 0.1s;
        }
        .batch-item:hover { background-color: var(--secondary-color); transform: translateY(-2px); }
        .batch-item button { margin-left: 1rem; }

        /* Tab Navigation */
        .tab-nav { 
            display: flex; 
            border-bottom: 1px solid var(--border-color); 
            margin-bottom: 1.5rem;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 0.75rem 1.25rem;
            border: 1px solid transparent;
            border-bottom: none;
            background-color: var(--secondary-color);
            color: var(--text-secondary);
            cursor: pointer;
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .tab-button.active {
            background-color: var(--card-background);
            color: var(--primary-color);
            border-color: var(--border-color);
            border-bottom-color: var(--card-background); 
            position: relative;
            z-index: 1;
        }
        .tab-button:hover:not(.active) {
            background-color: #e2e8f0;
            color: var(--text-primary);
        }
        .tab-content { display: none; padding-top: 1rem;}
        .tab-content.active { display: block; }

        /* Autofill Suggestions */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid var(--border-color);
            background-color: white;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .autocomplete-suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .autocomplete-suggestion-item:last-child {
            border-bottom: none;
        }

        .autocomplete-suggestion-item:hover,
        .autocomplete-suggestion-item.active { 
            background-color: var(--primary-color);
            color: white;
        }

        /* Dedicated sections for data types */
        .data-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed var(--border-color);
        }
        .data-section-header h3 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin: 0;
        }

        /* Unlisted Items table adjustments for new structure */
        .unlisted-item-row {
            border-bottom: 1px solid var(--light-border);
            padding: 0.75rem 0;
            font-size: 0.95rem;
        }
        .unlisted-item-row:last-child {
            border-bottom: none;
        }
        .unlisted-item-row .unlisted-header {
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
        }
        .unlisted-item-row .unlisted-locations-list {
            list-style: disc;
            padding-left: 1.2rem;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .unlisted-item-row .unlisted-locations-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.2rem 0;
        }
        .unlisted-item-row .unlisted-locations-list li .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        .add-unlisted-location-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--light-border);
        }
        .add-unlisted-location-form input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
            min-width: 70px;
        }
        .add-unlisted-location-form button {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .opname-group-header .header-top-row { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .opname-group-header .physical-count-form-header { flex-wrap: wrap; }
            .opname-group-header .physical-count-form-header input { width: calc(50% - 0.25rem); }
            .opname-group-header .physical-count-form-header button { width: 100%; }

            .opname-item-detail { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: flex-start; }
            .header-controls { justify-content: flex-start; width: 100%; }
            .opname-item-detail .physical-locations { grid-row: 2; } 
            .tab-nav { justify-content: center; }
            .container { padding: 1rem; }
            .card { padding: 1rem 1.2rem; }
            h1 { font-size: 1.75rem; }
            h2 { font-size: 1.25rem; }
            .sticky-controls { padding: 0.75rem 0; }
            .opname-list-scroll-area {
                max-height: calc(100vh - 280px); 
            }
            .add-unlisted-location-form { flex-wrap: wrap; }
            .add-unlisted-location-form input { width: calc(50% - 0.25rem); }
            .add-unlisted-location-form button { width: 100%; }
        }

        @media (max-width: 480px) {
            .opname-group-header { font-size: 1rem; padding: 0.6rem 0.8rem; }
            button { padding: 0.6rem 1rem; font-size: 0.9rem; }
            input, select { padding: 0.6rem 0.8rem; font-size: 0.9rem; }
            .batch-item { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .batch-item button { margin-left: 0; margin-top: 0.5rem; }
            .header-controls select { min-width: unset; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="batch-view" class="view active">
            <header>
                <h1>Sistem Stok Opname</h1>
                <div class="header-controls">
                    <label for="user-role-select">Anda Masuk Sebagai:</label>
                    <select id="user-role-select">
                        <option value="admin">Admin</option>
                        <option value="operator">Operator</option>
                    </select>
                </div>
            </header>
            
            <div class="card" id="admin-batch-controls">
                <h2>Buat Batch Opname Baru</h2>
                <form id="new-batch-form" style="display:flex; flex-direction:row; align-items:center; gap: 0.75rem;">
                    <input type="text" id="batch-name-input" placeholder="Cth: Opname Gudang A - Juli 2025" required>
                    <button type="submit">Buat Batch</button>
                </form>
            </div>
            <div class="card">
                <h2>Pilih Batch Tersedia</h2>
                <div id="batch-list"><p>Belum ada batch yang dibuat.</p></div>
            </div>
        </div>

        <div id="opname-view" class="view">
            <header>
                <h1 id="opname-title">Batch Opname</h1>
                <div class="header-controls">
                    <label for="user-role-select-opname">Anda Masuk Sebagai:</label>
                    <select id="user-role-select-opname">
                        <option value="admin">Admin</option>
                        <option value="operator">Operator</option>
                    </select>
                    <button id="back-to-batch-list" class="secondary">⬅️ Kembali ke Daftar Batch</button>
                    <button id="view-summary-btn">📊 Lihat & Ekspor Ringkasan</button>
                    <button id="download-full-opname-data" class="primary">⬇️ Unduh Data Opname Lengkap</button>
                </div>
            </header>

            <div id="admin-upload-section" class="card hidden">
                <h2>Upload Data Stok Awal (File Excel)</h2>
                <p>Unggah file Excel stok awal Anda. Pastikan format kolom: A (Deskripsi Barang), B (Lokasi), C (Jumlah).</p>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">
                    <input type="file" id="excel-file-input" accept=".xlsx, .xls">
                    <button type="button" id="download-template-btn" class="secondary">📥 Unduh Template Excel</button>
                </div>
            </div>

            <div id="operator-section" class="card hidden">
                <div class="tab-nav">
                    <button class="tab-button active" data-tab="opname-list-tab">Daftar Opname</button>
                    <button class="tab-button" data-tab="unlisted-items-tab">Barang Temuan</button>
                </div>

                <div id="opname-list-tab" class="tab-content active">
                    <h2>Input Fisik (Stok Sistem)</h2>
                    <p>Input jumlah fisik untuk item yang terdaftar di sistem. Anda dapat menginput jumlah fisik per lokasi.</p>
                    <div class="sticky-controls">
                        <input type="text" id="search-opname-input" placeholder="Cari item berdasarkan deskripsi atau lokasi..." style="margin-bottom: 0.75rem;">
                        <div class="pagination-controls">
                            <button id="prev-page-opname">Sebelumnya</button>
                            <span id="page-info-opname">Halaman 1 dari 1</span>
                            <button id="next-page-opname">Berikutnya</button>
                        </div>
                    </div>
                    <div id="opname-list-scroll-area" class="opname-list-scroll-area">
                        <div id="opname-item-list"></div>
                    </div>
                </div>
                
                <div id="unlisted-items-tab" class="tab-content">
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem;">
                        <h2>Daftar Barang Temuan (Tidak Terdaftar di Sistem)</h2>
                        <button id="open-unlisted-modal-btn">➕ Tambah Barang Temuan Baru</button>
                    </div>
                    <div class="sticky-controls">
                        <input type="text" id="search-unlisted-input" placeholder="Cari barang temuan berdasarkan deskripsi..." style="margin-bottom: 0.75rem;">
                        <div class="pagination-controls">
                            <button id="prev-page-unlisted">Sebelumnya</button>
                            <span id="page-info-unlisted">Halaman 1 dari 1</span>
                            <button id="next-page-unlisted">Berikutnya</button>
                        </div>
                    </div>
                    <div id="unlisted-items-display"></div>
                </div>
            </div>
        </div>
        
        <div id="summary-view" class="view">
            <header>
                <h1 id="summary-title">Ringkasan Batch Opname</h1>
                <div class="header-controls">
                    <label for="user-role-select-summary">Anda Masuk Sebagai:</label>
                    <select id="user-role-select-summary">
                        <option value="admin">Admin</option>
                        <option value="operator">Operator</option>
                    </select>
                    <button id="back-to-opname" class="secondary">⬅️ Kembali ke Opname</button>
                    <button id="download-summary-excel" class="primary">⬇️ Unduh Ringkasan Excel</button>
                </div>
            </header>
            <div class="card">
                <h2>Hasil Perbandingan Stok (Berdasarkan Deskripsi Item)</h2>
                <div class="table-wrapper">
                    <table id="summary-table">
                        <thead>
                            <tr>
                                <th>Deskripsi Barang</th>
                                <th>Total Qty Sistem</th>
                                <th>Total Qty Fisik</th>
                                <th>Selisih Total</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h2>Barang Temuan (Berdasarkan Deskripsi Item)</h2>
                <div class="table-wrapper">
                    <table id="unlisted-summary-table">
                        <thead>
                            <tr>
                                <th>Deskripsi Barang</th>
                                <th>Total Qty Fisik</th>
                            </tr>
                        </thead>
                        <tbody id="unlisted-summary-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h2>Ringkasan Stok Berdasarkan Lokasi</h2>
                <div class="table-wrapper">
                    <table id="location-summary-table">
                        <thead><tr><th>Lokasi</th><th>Qty Sistem</th><th>Qty Fisik (termasuk temuan)</th><th>Selisih</th></tr></thead>
                        <tbody id="location-summary-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="unlisted-item-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2>Tambah Barang Temuan Baru</h2>
            <form id="unlisted-item-form">
                <label for="unlisted-desc">Deskripsi Barang:</label>
                <div class="autocomplete-container">
                    <input type="text" id="unlisted-desc" placeholder="Cth: Meja Kayu" required>
                    <div id="unlisted-desc-suggestions" class="autocomplete-suggestions"></div>
                </div>
                <label for="unlisted-loc">Lokasi Fisik:</label>
                <input type="text" id="unlisted-loc" placeholder="Cth: Gudang-B, Rak 3" required>
                <label for="unlisted-qty">Jumlah Fisik:</label>
                <input type="number" id="unlisted-qty" placeholder="Cth: 5" min="1" required>
                <button type="submit">Simpan Temuan</button>
            </form>
        </div>
    </div>

    <div id="edit-initial-item-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2>Edit Item Stok Sistem</h2>
            <form id="edit-initial-item-form">
                <input type="hidden" id="edit-initial-item-id">
                <label for="edit-initial-desc">Deskripsi Barang:</label>
                <input type="text" id="edit-initial-desc" required>
                <label for="edit-initial-loc">Lokasi Sistem:</label>
                <input type="text" id="edit-initial-loc" required>
                <label for="edit-initial-qty">Jumlah Sistem:</label>
                <input type="number" id="edit-initial-qty" min="0" required>
                <button type="submit">Update Item</button>
            </form>
        </div>
    </div>

    <div id="edit-physical-count-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2>Edit Jumlah Fisik</h2>
            <form id="edit-physical-count-form">
                <input type="hidden" id="edit-physical-count-id">
                <input type="hidden" id="edit-physical-initial-id">
                <label for="edit-physical-desc">Deskripsi Barang:</label>
                <input type="text" id="edit-physical-desc" disabled>
                <label for="edit-physical-loc">Lokasi Fisik:</label>
                <input type="text" id="edit-physical-loc" required>
                <label for="edit-physical-qty">Jumlah Fisik:</label>
                <input type="number" id="edit-physical-qty" min="1" required>
                <button type="submit">Update Jumlah Fisik</button>
            </form>
        </div>
    </div>

    <div id="edit-unlisted-location-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2>Edit Lokasi & Jumlah Temuan</h2>
            <form id="edit-unlisted-location-form">
                <input type="hidden" id="edit-unlisted-loc-id">
                <input type="hidden" id="edit-unlisted-parent-desc">
                <label for="edit-unlisted-loc-desc">Deskripsi Barang:</label>
                <input type="text" id="edit-unlisted-loc-desc" disabled>
                <label for="edit-unlisted-loc-loc">Lokasi Fisik:</label>
                <input type="text" id="edit-unlisted-loc-loc" required>
                <label for="edit-unlisted-loc-qty">Jumlah Fisik:</label>
                <input type="number" id="edit-unlisted-loc-qty" min="1" required>
                <button type="submit">Update Lokasi & Jumlah</button>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let appData = JSON.parse(localStorage.getItem('stockOpnameApp')) || { batches: {}, currentUserRole: 'admin' };
        let currentBatchId = null;

        const ITEMS_PER_PAGE = 10; 
        let currentPageOpname = 1;
        let currentPageUnlisted = 1;

        // Store expanded group IDs to maintain state
        let expandedGroups = new Set();
        let expandedUnlistedGroups = new Set(); // New for unlisted groups

        // --- DOM Elements ---
        const views = document.querySelectorAll('.view');
        const newBatchForm = document.getElementById('new-batch-form');
        const batchNameInput = document.getElementById('batch-name-input');
        const batchList = document.getElementById('batch-list');
        const opnameTitle = document.getElementById('opname-title');
        const backToBatchListBtn = document.getElementById('back-to-batch-list');
        const viewSummaryBtn = document.getElementById('view-summary-btn');
        const adminUploadSection = document.getElementById('admin-upload-section');
        const excelFileInput = document.getElementById('excel-file-input');
        const downloadTemplateBtn = document.getElementById('download-template-btn');
        const operatorSection = document.getElementById('operator-section');
        const opnameItemList = document.getElementById('opname-item-list');
        const unlistedItemModal = document.getElementById('unlisted-item-modal');
        const openUnlistedModalBtn = document.getElementById('open-unlisted-modal-btn');
        const unlistedItemForm = document.getElementById('unlisted-item-form');
        const unlistedItemsDisplay = document.getElementById('unlisted-items-display'); // Changed to a div
        const summaryTitle = document.getElementById('summary-title');
        const summaryTableBody = document.getElementById('summary-table-body');
        const unlistedSummaryBody = document.getElementById('unlisted-summary-body');
        const locationSummaryBody = document.getElementById('location-summary-body');
        const backToOpnameBtn = document.getElementById('back-to-opname');
        const downloadSummaryExcelBtn = document.getElementById('download-summary-excel');
        const downloadFullOpnameDataBtn = document.getElementById('download-full-opname-data'); // New button

        // Elements for user roles
        const userRoleSelectBatch = document.getElementById('user-role-select');
        const userRoleSelectOpname = document.getElementById('user-role-select-opname');
        const userRoleSelectSummary = document.getElementById('user-role-select-summary');
        const adminBatchControls = document.getElementById('admin-batch-controls');

        // New elements for tabs and search
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const searchOpnameInput = document.getElementById('search-opname-input');
        const searchUnlistedInput = document.getElementById('search-unlisted-input');

        // Pagination elements for Opname List
        const prevPageOpnameBtn = document.getElementById('prev-page-opname');
        const nextPageOpnameBtn = document.getElementById('next-page-opname');
        const pageInfoOpnameSpan = document.getElementById('page-info-opname');

        // Pagination elements for Unlisted Items
        const prevPageUnlistedBtn = document.getElementById('prev-page-unlisted');
        const nextPageUnlistedBtn = document.getElementById('next-page-unlisted');
        const pageInfoUnlistedSpan = document.getElementById('page-info-unlisted');

        // Edit Modals and Forms
        const editInitialItemModal = document.getElementById('edit-initial-item-modal');
        const editInitialItemForm = document.getElementById('edit-initial-item-form');
        const editPhysicalCountModal = document.getElementById('edit-physical-count-modal');
        const editPhysicalCountForm = document.getElementById('edit-physical-count-form');
        const editUnlistedLocationModal = document.getElementById('edit-unlisted-location-modal'); // Renamed
        const editUnlistedLocationForm = document.getElementById('edit-unlisted-location-form'); // Renamed

        // Autofill elements
        const unlistedDescInput = document.getElementById('unlisted-desc');
        const unlistedDescSuggestions = document.getElementById('unlisted-desc-suggestions');
        // No longer need editUnlistedDescInput/Suggestions for unlisted items because editing is per-location.


        // --- Core Functions ---
        const saveData = () => localStorage.setItem('stockOpnameApp', JSON.stringify(appData));
        const switchView = (viewId) => {
            views.forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            // Sync role selection when switching views
            const currentRole = appData.currentUserRole;
            userRoleSelectBatch.value = currentRole;
            userRoleSelectOpname.value = currentRole;
            userRoleSelectSummary.value = currentRole;
            applyUserRole(currentRole);
        };

        const applyUserRole = (role) => {
            appData.currentUserRole = role;
            saveData();

            const isAdmin = role === 'admin';
            const isOperator = role === 'operator';

            // Batch View Controls
            adminBatchControls.classList.toggle('hidden', !isAdmin);
            document.querySelectorAll('#batch-list .batch-item button.danger').forEach(btn => {
                btn.disabled = !isAdmin;
            });

            // Opname View Controls
            adminUploadSection.classList.toggle('hidden', !isAdmin);
            excelFileInput.disabled = !isAdmin;
            downloadTemplateBtn.disabled = !isAdmin;
            downloadFullOpnameDataBtn.disabled = false; // Both can download full data

            // Opname Item List (Edit/Delete Initial Items)
            document.querySelectorAll('.opname-item-detail .item-sys-detail-info button.edit, .opname-item-detail .item-sys-detail-info button.danger').forEach(btn => {
                btn.disabled = !isAdmin;
            });

            // Disable/enable header physical input for operator (operator can use it, admin cannot)
            document.querySelectorAll('.physical-count-form-header input, .physical-count-form-header button').forEach(el => {
                el.disabled = !isOperator; 
            });

            // Unlisted Items tab
            openUnlistedModalBtn.disabled = !isOperator; // Only operator can add new unlisted items

            // Controls within unlisted item groups (edit/delete location, add new location)
            document.querySelectorAll('.unlisted-item-row .unlisted-locations-list li button.edit, .unlisted-item-row .unlisted-locations-list li button.danger, .add-unlisted-location-form input, .add-unlisted-location-form button').forEach(el => {
                el.disabled = !isOperator;
            });

            // Disable Summary Download for operator
            downloadSummaryExcelBtn.disabled = !isAdmin;
        };

        // Initialize user role from storage or default to admin
        userRoleSelectBatch.value = appData.currentUserRole;
        userRoleSelectOpname.value = appData.currentUserRole;
        userRoleSelectSummary.value = appData.currentUserRole;
        applyUserRole(appData.currentUserRole);


        // --- Tab Management ---
        const activateTab = (tabId) => {
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            // Re-render relevant section when switching tabs
            if (tabId === 'opname-list-tab') {
                currentPageOpname = 1; // Reset to first page
                renderOpnameItems();
            } else if (tabId === 'unlisted-items-tab') {
                currentPageUnlisted = 1; // Reset to first page
                renderUnlistedItemsDisplay(); // Changed to the new render function
            }
        };

        tabButtons.forEach(button => {
            button.addEventListener('click', () => activateTab(button.dataset.tab));
        });

        const renderBatchList = () => {
            batchList.innerHTML = '';
            const batchIds = Object.keys(appData.batches);
            if (batchIds.length === 0) {
                batchList.innerHTML = '<p>Belum ada batch opname yang dibuat.</p>';
                return;
            }
            batchIds.sort((a, b) => appData.batches[b].createdAt - appData.batches[a].createdAt).forEach(id => {
                const batch = appData.batches[id];
                const item = document.createElement('div');
                item.className = 'batch-item';
                item.dataset.id = id;
                item.innerHTML = `
                    <div>
                        <strong>${batch.name}</strong><br>
                        <small>${new Date(batch.createdAt).toLocaleString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</small>
                    </div>
                    <div>
                        <button class="small-btn danger" data-id="${id}" onclick="deleteBatch(event)">Hapus</button>
                    </div>
                `;
                item.querySelector('div:first-child').addEventListener('click', () => selectBatch(id));
                batchList.appendChild(item);
            });
            applyUserRole(appData.currentUserRole); 
        };

        const createBatch = (e) => {
            e.preventDefault();
            if (appData.currentUserRole !== 'admin') {
                alert('Anda tidak memiliki izin untuk membuat batch baru.');
                return;
            }
            const name = batchNameInput.value.trim();
            if (name) {
                const id = `batch_${Date.now()}`;
                appData.batches[id] = { id, name: name, createdAt: Date.now(), initialData: [], physicalData: [] };
                batchNameInput.value = '';
                saveData();
                renderBatchList();
            }
        };

        window.deleteBatch = (event) => {
            event.stopPropagation();
            if (appData.currentUserRole !== 'admin') {
                alert('Anda tidak memiliki izin untuk menghapus batch.');
                return;
            }
            const batchIdToDelete = event.target.dataset.id;
            if (confirm(`Anda yakin ingin menghapus batch "${appData.batches[batchIdToDelete].name}"? Semua data di dalamnya akan hilang.`)) {
                delete appData.batches[batchIdToDelete];
                saveData();
                renderBatchList();
                if (currentBatchId === batchIdToDelete) {
                    currentBatchId = null;
                    switchView('batch-view');
                }
            }
        };

        const selectBatch = (id) => {
            currentBatchId = id;
            const batch = appData.batches[currentBatchId];
            opnameTitle.textContent = `Batch: ${batch.name}`;
            if (batch.initialData.length === 0) {
                adminUploadSection.classList.remove('hidden');
                operatorSection.classList.add('hidden');
            } else {
                adminUploadSection.classList.add('hidden');
                operatorSection.classList.remove('hidden');
                renderOperatorView();
            }
            switchView('opname-view');
            activateTab('opname-list-tab'); 
            // Clear expanded groups when switching batches or views
            expandedGroups.clear();
            expandedUnlistedGroups.clear();
        };

        const handleFileUpload = (e) => {
            if (appData.currentUserRole !== 'admin') {
                alert('Anda tidak memiliki izin untuk mengunggah data stok awal.');
                excelFileInput.value = ''; 
                return;
            }
            const file = e.target.files[0];
            if (!file || !currentBatchId) return;

            if (appData.batches[currentBatchId].initialData.length > 0 && 
                !confirm("Batch ini sudah memiliki data stok awal. Mengunggah yang baru akan menimpa data lama dan semua input fisik yang terkait. Lanjutkan?")) {
                excelFileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: '' });

                    const rows = rawData.slice(1).filter(row => row && row.length >= 3 && String(row[0]).trim()); 

                    const batch = appData.batches[currentBatchId];
                    batch.initialData = [];
                    batch.physicalData = batch.physicalData.filter(p => p.type === 'unlisted'); // Keep unlisted data

                    const tempInitialData = [];
                    rows.forEach((row, rowIndex) => {
                        const description = String(row[0] || '').trim();
                        const location = String(row[1] || '').trim();
                        const quantity = parseInt(row[2], 10) || 0;

                        if (!description) {
                            console.warn(`Skipping row ${rowIndex + 2} due to empty description.`);
                            return;
                        }

                        // Check for duplicate description + location
                        const existingEntryIndex = tempInitialData.findIndex(item => 
                            item.description.toLowerCase() === description.toLowerCase() && 
                            item.location.toLowerCase() === location.toLowerCase()
                        );

                        if (existingEntryIndex > -1) {
                            tempInitialData[existingEntryIndex].quantity += quantity;
                        } else {
                            tempInitialData.push({
                                id: `item_${Date.now()}_${rowIndex}_${Math.random().toString(36).substring(2, 6)}`, 
                                description: description,
                                location: location,
                                quantity: quantity
                            });
                        }
                    });

                    batch.initialData = tempInitialData;
                    
                    saveData();
                    selectBatch(currentBatchId);
                    excelFileInput.value = '';
                    alert("Data stok awal berhasil diunggah dan digabungkan (jika deskripsi & lokasi sama persis). Barang temuan (yang tidak terdaftar di sistem) tetap dipertahankan.");
                } catch (error) {
                    console.error("Error processing Excel file:", error);
                    alert("Gagal memproses file Excel. Pastikan formatnya benar (Kolom A: Deskripsi, Kolom B: Lokasi, Kolom C: Jumlah). Detail error di konsol.");
                }
            };
            reader.readAsArrayBuffer(file);
        };

        const downloadTemplate = () => {
            const data = [['Deskripsi Barang', 'Lokasi', 'Jumlah'], ['Contoh: Buku Tulis', 'Contoh: RAK-A1', 100]];
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Stok');
            XLSX.writeFile(wb, 'Template_Stok_Opname.xlsx');
        };

        const renderOperatorView = () => {
            renderOpnameItems();
            renderUnlistedItemsDisplay(); 
            activateTab(document.querySelector('.tab-button.active').dataset.tab);
        };

        let lastScrollPosition = 0; 

        const renderOpnameItems = (maintainScroll = false) => {
            if (maintainScroll) {
                lastScrollPosition = opnameItemList.scrollTop;
            } else {
                opnameItemList.scrollTop = 0; 
            }

            opnameItemList.innerHTML = '';
            const batch = appData.batches[currentBatchId];
            if (!batch || batch.initialData.length === 0) {
                opnameItemList.innerHTML = '<p>Silakan unggah data stok awal terlebih dahulu.</p>';
                return;
            }

            const searchTerm = searchOpnameInput.value.toLowerCase();
            
            const groupedItemsMap = new Map(); 
            batch.initialData.forEach(item => {
                const descKey = item.description.toLowerCase();
                if (!groupedItemsMap.has(descKey)) {
                    groupedItemsMap.set(descKey, {
                        description: item.description,
                        items: [], 
                        totalSystemQty: 0
                    });
                }
                groupedItemsMap.get(descKey).items.push(item);
                groupedItemsMap.get(descKey).totalSystemQty += item.quantity;
            });

            let filteredGroups = Array.from(groupedItemsMap.values()).filter(group => {
                if (group.description.toLowerCase().includes(searchTerm)) {
                    return true;
                }
                return group.items.some(item => item.location.toLowerCase().includes(searchTerm));
            }).sort((a, b) => a.description.localeCompare(b.description)); 

            const totalPages = Math.ceil(filteredGroups.length / ITEMS_PER_PAGE);
            currentPageOpname = Math.max(1, Math.min(currentPageOpname, totalPages)); 
            
            const startIndex = (currentPageOpname - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedGroups = filteredGroups.slice(startIndex, endIndex);

            pageInfoOpnameSpan.textContent = `Halaman ${totalPages > 0 ? currentPageOpname : 0} dari ${totalPages}`;
            prevPageOpnameBtn.disabled = currentPageOpname === 1 || totalPages === 0;
            nextPageOpnameBtn.disabled = currentPageOpname === totalPages || totalPages === 0;

            if (paginatedGroups.length === 0) {
                opnameItemList.innerHTML = '<p>Tidak ada item stok sistem yang cocok dengan pencarian atau halaman ini.</p>';
                return;
            }

            paginatedGroups.forEach(group => {
                const groupEl = document.createElement('div');
                groupEl.className = 'opname-group';
                
                const isExpanded = expandedGroups.has(group.description); 

                groupEl.innerHTML = `
                    <div class="opname-group-header ${isExpanded ? '' : 'collapsed'}" data-group-desc="${group.description}">
                        <div class="header-top-row">
                            <span>${group.description}</span>
                            <div class="action-buttons">
                                <span class="toggle-icon">${isExpanded ? '▼' : '▶'}</span>
                            </div>
                        </div>
                        <form class="physical-count-form-header" data-group-desc="${group.description}">
                            <input type="text" placeholder="Lokasi Fisik" required>
                            <input type="number" placeholder="Jml Fisik" min="1" required>
                            <button type="submit" class="small-btn">+</button>
                        </form>
                    </div>
                    <div class="opname-group-content ${isExpanded ? 'expanded' : ''}">
                        <div class="data-section-header">
                            <h3>Data Stok Sistem</h3>
                        </div>
                        <div class="system-items-list"></div>
                        <div class="data-section-header">
                            <h3>Data Stok Fisik (Opname)</h3>
                        </div>
                        <div class="physical-counts-list"></div>
                    </div>
                `;
                
                const systemItemsListEl = groupEl.querySelector('.system-items-list');
                const physicalCountsListEl = groupEl.querySelector('.physical-counts-list');
                
                // Filtering system items for display within expanded group based on search term (if present)
                const itemsToDisplayInGroup = group.description.toLowerCase().includes(searchTerm) 
                    ? group.items 
                    : group.items.filter(item => item.location.toLowerCase().includes(searchTerm));

                itemsToDisplayInGroup.sort((a,b) => a.location.localeCompare(b.location));

                if (itemsToDisplayInGroup.length === 0) {
                    systemItemsListEl.innerHTML = '<p class="item-sys-detail-info">Tidak ada item stok sistem yang cocok dengan pencarian di grup ini.</p>';
                } else {
                    itemsToDisplayInGroup.forEach(item => {
                        const itemDetailEl = document.createElement('div');
                        itemDetailEl.className = 'opname-item-detail';
                        itemDetailEl.dataset.itemId = item.id; 
                        itemDetailEl.innerHTML = `
                            <div>
                                <p class="item-sys-detail-info">Lokasi Sistem: <strong>${item.location}</strong> (Qty: ${item.quantity})
                                    <span class="action-buttons">
                                        <button class="small-btn edit" onclick="openEditInitialItemModal('${item.id}')">Edit</button>
                                        <button class="small-btn danger" onclick="deleteInitialItem('${item.id}')">Hapus</button>
                                    </span>
                                </p>
                            </div>
                            <div></div> 
                        `;
                        systemItemsListEl.appendChild(itemDetailEl);
                    });
                }


                // Render physical counts related to this description group
                const physicalsForGroup = batch.physicalData.filter(p => {
                    // Find an initial item that matches this physical count's description.
                    // This is for display grouping, linking is still via initialId if it exists.
                    const initialItemForPhysical = batch.initialData.find(item => item.id === p.initialId);
                    return p.type === 'found' && 
                           (initialItemForPhysical ? initialItemForPhysical.description.toLowerCase() === group.description.toLowerCase() : false);
                }).sort((a,b) => a.location.localeCompare(b.location));

                if (physicalsForGroup.length === 0) {
                    physicalCountsListEl.innerHTML = '<p class="item-sys-detail-info">Belum ada input fisik untuk deskripsi ini.</p>';
                } else {
                    const ul = document.createElement('ul');
                    ul.className = 'physical-locations';
                    physicalsForGroup.forEach(p => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${p.quantity} di ${p.location}</span>
                            <div>
                                <button class="small-btn edit" onclick="openEditPhysicalCountModal('${p.id}')">Edit</button>
                                <button class="small-btn danger" onclick="deletePhysicalCount('${p.id}')">Hapus</button>
                            </div>
                        `;
                        ul.appendChild(li);
                    });
                    physicalCountsListEl.appendChild(ul);
                }

                opnameItemList.appendChild(groupEl);
            });
            document.querySelectorAll('.physical-count-form-header').forEach(form => {
                form.removeEventListener('submit', addPhysicalCountByGroup); // Prevent multiple listeners
                form.addEventListener('submit', addPhysicalCountByGroup);
            });

            document.querySelectorAll('.opname-group-header').forEach(header => {
                header.removeEventListener('click', toggleGroup); // Prevent multiple listeners
                header.addEventListener('click', toggleGroup);
            });
            
            applyUserRole(appData.currentUserRole); 

            if (maintainScroll) {
                opnameItemList.scrollTop = lastScrollPosition; 
            }
        };

        const toggleGroup = (event) => {
            // Only toggle if the click is not on the form inputs/buttons
            if (event.target.closest('.physical-count-form-header')) {
                return;
            }
            const header = event.currentTarget;
            const groupDesc = header.dataset.groupDesc;
            const content = header.nextElementSibling;
            const toggleIcon = header.querySelector('.toggle-icon');

            if (header.classList.contains('collapsed')) {
                header.classList.remove('collapsed');
                content.classList.add('expanded');
                toggleIcon.textContent = '▼';
                expandedGroups.add(groupDesc); 
            } else {
                header.classList.add('collapsed');
                content.classList.remove('expanded');
                toggleIcon.textContent = '▶';
                expandedGroups.delete(groupDesc); 
            }
        };


        const addPhysicalCountByGroup = (e) => {
            e.preventDefault();
            const form = e.target;
            const groupDescription = form.dataset.groupDesc; // Get description from group
            const loc = form.elements[0].value.trim();
            const qty = parseInt(form.elements[1].value, 10);

            if (appData.currentUserRole !== 'operator') {
                alert('Anda tidak memiliki izin untuk menginput stok fisik. Silakan masuk sebagai Operator.');
                return;
            }

            if (loc && qty > 0) {
                const batch = appData.batches[currentBatchId];
                
                // Find an initial item that matches the group description to link the physical count.
                // This ensures it's linked to *any* existing system item of that description.
                const relevantInitialItem = batch.initialData.find(item => 
                    item.description.toLowerCase() === groupDescription.toLowerCase()
                );

                if (!relevantInitialItem) {
                    alert('Tidak dapat menambahkan stok fisik. Deskripsi barang ini tidak ditemukan di data stok sistem. Jika ini barang baru, tambahkan di "Barang Temuan".');
                    return;
                }

                const existingPhysical = batch.physicalData.find(p => 
                    p.initialId === relevantInitialItem.id && // Linked to the specific initial item ID
                    p.type === 'found' && // Ensure it's a 'found' physical count
                    p.location.toLowerCase() === loc.toLowerCase()
                );

                if (existingPhysical) {
                    existingPhysical.quantity += qty; 
                } else {
                    batch.physicalData.push({
                        id: `phys_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
                        initialId: relevantInitialItem.id, // Link to an initial item with matching description
                        description: relevantInitialItem.description, // Store description for easier lookup
                        location: loc,
                        quantity: qty,
                        type: 'found' 
                    });
                }
                
                saveData();
                renderOpnameItems(true); 
                form.reset();
            }
        };

        window.openEditInitialItemModal = (itemId) => {
            if (appData.currentUserRole !== 'admin') {
                alert('Anda tidak memiliki izin untuk mengedit item stok sistem.');
                return;
            }
            const batch = appData.batches[currentBatchId];
            const item = batch.initialData.find(i => i.id === itemId);
            if (item) {
                document.getElementById('edit-initial-item-id').value = item.id;
                document.getElementById('edit-initial-desc').value = item.description;
                document.getElementById('edit-initial-loc').value = item.location;
                document.getElementById('edit-initial-qty').value = item.quantity;
                editInitialItemModal.classList.add('active');
            }
        };

        editInitialItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (appData.currentUserRole !== 'admin') {
                alert('Anda tidak memiliki izin untuk mengedit item stok sistem.');
                return;
            }
            const itemId = document.getElementById('edit-initial-item-id').value;
            const newDesc = document.getElementById('edit-initial-desc').value.trim();
            const newLoc = document.getElementById('edit-initial-loc').value.trim();
            const newQty = parseInt(document.getElementById('edit-initial-qty').value, 10);

            const batch = appData.batches[currentBatchId];
            const itemIndex = batch.initialData.findIndex(i => i.id === itemId);

            if (itemIndex > -1 && newDesc && newLoc && newQty >= 0) {
                const currentItem = batch.initialData[itemIndex];
                
                const existingItemWithNewProps = batch.initialData.find(item => 
                    item.id !== itemId && 
                    item.description.toLowerCase() === newDesc.toLowerCase() && 
                    item.location.toLowerCase() === newLoc.toLowerCase()
                );

                if (existingItemWithNewProps) {
                    if (confirm(`Item dengan deskripsi "${newDesc}" dan lokasi "${newLoc}" sudah ada di data sistem. Apakah Anda yakin ingin menggabungkan kuantitas item ini ke item yang sudah ada? Semua input fisik terkait item ini akan dipindahkan ke item gabungan.`)) {
                        existingItemWithNewProps.quantity += newQty;
                        // Relink physical counts from old ID to new ID
                        batch.physicalData.forEach(p => {
                            if (p.initialId === itemId) {
                                p.initialId = existingItemWithNewProps.id;
                                p.description = existingItemWithNewProps.description; // Update description if it changed during merge
                            }
                        });
                        batch.initialData.splice(itemIndex, 1); 
                    } else {
                        return; 
                    }
                } else {
                    currentItem.description = newDesc;
                    currentItem.location = newLoc;
                    currentItem.quantity = newQty;

                    // Update description for associated physical counts if description changes
                    batch.physicalData.forEach(p => {
                        if (p.initialId === itemId) {
                            p.description = newDesc;
                        }
                    });
                }
                
                saveData();
                renderOpnameItems(true); 
                editInitialItemModal.classList.remove('active');
            }
        });

        window.deleteInitialItem = (itemId) => {
            if (appData.currentUserRole !== 'admin') {
                alert('Anda tidak memiliki izin untuk menghapus item stok sistem.');
                return;
            }
            if (confirm("Anda yakin ingin menghapus item ini dari daftar stok sistem? Semua input fisik terkait juga akan dihapus.")) {
                const batch = appData.batches[currentBatchId];
                batch.initialData = batch.initialData.filter(item => item.id !== itemId);
                batch.physicalData = batch.physicalData.filter(p => p.initialId !== itemId); 
                saveData();
                renderOpnameItems(true); 
            }
        };

        window.openEditPhysicalCountModal = (physicalId) => {
            const batch = appData.batches[currentBatchId];
            const physical = batch.physicalData.find(p => p.id === physicalId && p.type === 'found');
            if (physical) {
                document.getElementById('edit-physical-count-id').value = physical.id;
                document.getElementById('edit-physical-initial-id').value = physical.initialId;
                document.getElementById('edit-physical-desc').value = physical.description; 
                document.getElementById('edit-physical-loc').value = physical.location;
                document.getElementById('edit-physical-qty').value = physical.quantity;
                editPhysicalCountModal.classList.add('active');
            }
        };

        editPhysicalCountForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const physicalId = document.getElementById('edit-physical-count-id').value;
            const newLoc = document.getElementById('edit-physical-loc').value.trim();
            const newQty = parseInt(document.getElementById('edit-physical-qty').value, 10);

            const batch = appData.batches[currentBatchId];
            const physicalIndex = batch.physicalData.findIndex(p => p.id === physicalId && p.type === 'found');

            if (physicalIndex > -1 && newLoc && newQty > 0) {
                const currentPhysical = batch.physicalData[physicalIndex];
                
                const existingPhysicalWithNewProps = batch.physicalData.find(p => 
                    p.id !== physicalId && 
                    p.type === 'found' &&
                    p.initialId === currentPhysical.initialId && 
                    p.location.toLowerCase() === newLoc.toLowerCase() 
                );

                if (existingPhysicalWithNewProps) {
                    if (confirm(`Sudah ada input fisik untuk item ini di lokasi "${newLoc}". Apakah Anda yakin ingin menggabungkan kuantitas ini?`)) {
                        existingPhysicalWithNewProps.quantity += newQty;
                        batch.physicalData.splice(physicalIndex, 1); 
                    } else {
                        return; 
                    }
                } else {
                    currentPhysical.location = newLoc;
                    currentPhysical.quantity = newQty;
                }
                
                saveData();
                renderOpnameItems(true); 
                editPhysicalCountModal.classList.remove('active');
            }
        });

        window.deletePhysicalCount = (physicalId) => {
            if (confirm("Anda yakin ingin menghapus entri fisik ini?")) {
                const batch = appData.batches[currentBatchId];
                batch.physicalData = batch.physicalData.filter(p => p.id !== physicalId);
                saveData();
                renderOpnameItems(true); 
            }
        };

        const renderUnlistedItemsDisplay = () => {
            unlistedItemsDisplay.innerHTML = '';
            const batch = appData.batches[currentBatchId];
            if (!batch) return;
            const searchTerm = searchUnlistedInput.value.toLowerCase();

            // Group unlisted items by description
            const groupedUnlistedMap = new Map();
            batch.physicalData.filter(p => p.type === 'unlisted').forEach(item => {
                const descKey = item.description.toLowerCase();
                if (!groupedUnlistedMap.has(descKey)) {
                    groupedUnlistedMap.set(descKey, {
                        description: item.description,
                        locations: [] // This will hold the individual physical count objects (including their IDs)
                    });
                }
                groupedUnlistedMap.get(descKey).locations.push(item);
            });

            let filteredGroups = Array.from(groupedUnlistedMap.values()).filter(group => {
                return group.description.toLowerCase().includes(searchTerm);
            }).sort((a, b) => a.description.localeCompare(b.description));

            const totalPages = Math.ceil(filteredGroups.length / ITEMS_PER_PAGE);
            currentPageUnlisted = Math.max(1, Math.min(currentPageUnlisted, totalPages)); 

            const startIndex = (currentPageUnlisted - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedGroups = filteredGroups.slice(startIndex, endIndex);

            pageInfoUnlistedSpan.textContent = `Halaman ${totalPages > 0 ? currentPageUnlisted : 0} dari ${totalPages}`;
            prevPageUnlistedBtn.disabled = currentPageUnlisted === 1 || totalPages === 0;
            nextPageUnlistedBtn.disabled = currentPageUnlisted === totalPages || totalPages === 0;

            if (paginatedGroups.length === 0) {
                unlistedItemsDisplay.innerHTML = '<p>Belum ada barang temuan atau tidak ada yang cocok dengan pencarian.</p>';
                return;
            }

            paginatedGroups.forEach(group => {
                const groupEl = document.createElement('div');
                groupEl.className = 'card unlisted-item-row'; 
                const isExpanded = expandedUnlistedGroups.has(group.description);

                groupEl.innerHTML = `
                    <div class="unlisted-header" data-group-desc="${group.description}">
                        <span>${group.description}</span>
                        <div class="action-buttons">
                            <button class="small-btn edit" onclick="openAddUnlistedLocationModal('${group.description}')">➕ Tambah Lokasi</button>
                            <button class="small-btn danger" onclick="deleteUnlistedGroup('${group.description}')">Hapus Semua</button>
                            <span class="toggle-icon">${isExpanded ? '▼' : '▶'}</span>
                        </div>
                    </div>
                    <div class="opname-group-content ${isExpanded ? 'expanded' : ''}">
                        <ul class="unlisted-locations-list"></ul>
                    </div>
                `;

                const ul = groupEl.querySelector('.unlisted-locations-list');
                group.locations.sort((a,b) => a.location.localeCompare(b.location));
                group.locations.forEach(locItem => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${locItem.quantity} di ${locItem.location}</span>
                        <div class="action-buttons">
                            <button class="small-btn edit" onclick="openEditUnlistedLocationModal('${locItem.id}')">Edit</button>
                            <button class="small-btn danger" onclick="deleteUnlistedLocation('${locItem.id}')">Hapus</button>
                        </div>
                    `;
                    ul.appendChild(li);
                });

                unlistedItemsDisplay.appendChild(groupEl);
            });

            // Re-attach event listeners for toggle
            document.querySelectorAll('.unlisted-item-row .unlisted-header').forEach(header => {
                header.removeEventListener('click', toggleUnlistedGroup); // Prevent multiple
                header.addEventListener('click', toggleUnlistedGroup);
            });

            applyUserRole(appData.currentUserRole); 
        };

        const toggleUnlistedGroup = (event) => {
            if (event.target.closest('button')) { // Don't toggle if a button within header is clicked
                return;
            }
            const header = event.currentTarget;
            const groupDesc = header.dataset.groupDesc;
            const content = header.nextElementSibling;
            const toggleIcon = header.querySelector('.toggle-icon');

            if (header.classList.contains('collapsed')) {
                header.classList.remove('collapsed');
                content.classList.add('expanded');
                toggleIcon.textContent = '▼';
                expandedUnlistedGroups.add(groupDesc); 
            } else {
                header.classList.add('collapsed');
                content.classList.remove('expanded');
                toggleIcon.textContent = '▶';
                expandedUnlistedGroups.delete(groupDesc); 
            }
        };


        const addUnlistedItem = (e) => {
            e.preventDefault();
            const desc = unlistedDescInput.value.trim();
            const loc = document.getElementById('unlisted-loc').value.trim();
            const qty = parseInt(document.getElementById('unlisted-qty').value, 10);

            if (appData.currentUserRole !== 'operator') {
                alert('Anda tidak memiliki izin untuk menambah barang temuan baru. Silakan masuk sebagai Operator.');
                return;
            }

            if (desc && loc && qty > 0) {
                const batch = appData.batches[currentBatchId];
                
                const existingUnlisted = batch.physicalData.find(p => 
                    p.type === 'unlisted' &&
                    p.description.toLowerCase() === desc.toLowerCase() &&
                    p.location.toLowerCase() === loc.toLowerCase()
                );

                if (existingUnlisted) {
                    existingUnlisted.quantity += qty; 
                } else {
                    batch.physicalData.push({ 
                        id: `unlisted_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`, 
                        initialId: null, 
                        description: desc, 
                        location: loc, 
                        quantity: qty, 
                        type: 'unlisted' 
                    });
                }
                
                saveData();
                renderUnlistedItemsDisplay();
                unlistedItemForm.reset();
                unlistedItemModal.classList.remove('active');
            }
        };

        // This modal allows adding *another* location/quantity for an existing unlisted item description
        window.openAddUnlistedLocationModal = (itemDescription) => {
            unlistedItemModal.classList.add('active'); // Re-use the existing "add unlisted" modal
            unlistedDescInput.value = itemDescription;
            unlistedDescInput.disabled = true; // Disable description input
            document.getElementById('unlisted-loc').value = ''; // Clear location
            document.getElementById('unlisted-qty').value = ''; // Clear quantity
            unlistedDescInput.focus();
        };

        // This modal allows editing an existing specific unlisted location entry
        window.openEditUnlistedLocationModal = (unlistedId) => {
            const batch = appData.batches[currentBatchId];
            const unlistedItem = batch.physicalData.find(p => p.id === unlistedId && p.type === 'unlisted');
            if (unlistedItem) {
                document.getElementById('edit-unlisted-loc-id').value = unlistedItem.id;
                document.getElementById('edit-unlisted-loc-desc').value = unlistedItem.description; // Disabled
                document.getElementById('edit-unlisted-loc-loc').value = unlistedItem.location;
                document.getElementById('edit-unlisted-loc-qty').value = unlistedItem.quantity;
                editUnlistedLocationModal.classList.add('active');
            }
        };

        editUnlistedLocationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const unlistedId = document.getElementById('edit-unlisted-loc-id').value;
            const newLoc = document.getElementById('edit-unlisted-loc-loc').value.trim();
            const newQty = parseInt(document.getElementById('edit-unlisted-loc-qty').value, 10);

            const batch = appData.batches[currentBatchId];
            const unlistedIndex = batch.physicalData.findIndex(p => p.id === unlistedId && p.type === 'unlisted');

            if (unlistedIndex > -1 && newLoc && newQty > 0) {
                const currentUnlisted = batch.physicalData[unlistedIndex];

                const existingUnlistedWithNewProps = batch.physicalData.find(p => 
                    p.id !== unlistedId && 
                    p.type === 'unlisted' &&
                    p.description.toLowerCase() === currentUnlisted.description.toLowerCase() && // Same description
                    p.location.toLowerCase() === newLoc.toLowerCase() 
                );

                if (existingUnlistedWithNewProps) {
                    if (confirm(`Lokasi "${newLoc}" untuk barang "${currentUnlisted.description}" sudah ada. Apakah Anda yakin ingin menggabungkan kuantitas ini?`)) {
                        existingUnlistedWithNewProps.quantity += newQty;
                        batch.physicalData.splice(unlistedIndex, 1);
                    } else {
                        return;
                    }
                } else {
                    currentUnlisted.location = newLoc;
                    currentUnlisted.quantity = newQty;
                }
                
                saveData();
                renderUnlistedItemsDisplay();
                editUnlistedLocationModal.classList.remove('active');
            }
        });

        window.deleteUnlistedLocation = (unlistedId) => {
            if (confirm("Anda yakin ingin menghapus entri lokasi dan jumlah ini dari barang temuan?")) {
                const batch = appData.batches[currentBatchId];
                batch.physicalData = batch.physicalData.filter(p => p.id !== unlistedId);
                saveData();
                renderUnlistedItemsDisplay();
            }
        };
        
        window.deleteUnlistedGroup = (itemDescription) => {
            if (appData.currentUserRole !== 'admin') {
                alert('Anda tidak memiliki izin untuk menghapus grup barang temuan.');
                return;
            }
            if (confirm(`Anda yakin ingin menghapus semua entri barang temuan untuk "${itemDescription}"?`)) {
                const batch = appData.batches[currentBatchId];
                batch.physicalData = batch.physicalData.filter(p => 
                    !(p.type === 'unlisted' && p.description.toLowerCase() === itemDescription.toLowerCase())
                );
                saveData();
                renderUnlistedItemsDisplay();
            }
        };

        const renderSummary = () => {
            const batch = appData.batches[currentBatchId];
            summaryTitle.textContent = `Ringkasan: ${batch.name}`;
            summaryTableBody.innerHTML = '';
            unlistedSummaryBody.innerHTML = '';
            locationSummaryBody.innerHTML = ''; 

            const groupedInitial = new Map(); 
            batch.initialData.forEach(item => {
                const descKey = item.description.toLowerCase();
                if (!groupedInitial.has(descKey)) {
                    groupedInitial.set(descKey, {
                        description: item.description,
                        systemDetails: [], 
                        physicalDetails: [], 
                        totalSystemQty: 0,
                        totalPhysicalQty: 0
                    });
                }
                const entry = groupedInitial.get(descKey);
                entry.systemDetails.push({ loc: item.location, qty: item.quantity });
                entry.totalSystemQty += item.quantity;
            });

            batch.physicalData.filter(p => p.type === 'found').forEach(p => {
                const initialItem = batch.initialData.find(item => item.id === p.initialId);
                const descKey = (initialItem ? initialItem.description : p.description).toLowerCase(); 
                if (groupedInitial.has(descKey)) { 
                    const entry = groupedInitial.get(descKey);
                    entry.physicalDetails.push({ loc: p.location, qty: p.quantity });
                    entry.totalPhysicalQty += p.quantity;
                }
            });

            if (groupedInitial.size === 0) {
                summaryTableBody.innerHTML = '<tr><td colspan="4">Tidak ada data stok sistem untuk diringkas.</td></tr>';
            } else {
                Array.from(groupedInitial.values()).sort((a,b) => a.description.localeCompare(b.description)).forEach(data => {
                    const selisih = data.totalPhysicalQty - data.totalSystemQty;
                    let selisihClass = selisih > 0 ? 'positive' : (selisih < 0 ? 'negative' : 'zero');
                    let selisihText = selisih > 0 ? `+${selisih}` : selisih;

                    data.systemDetails.sort((a,b) => a.loc.localeCompare(b.loc));
                    data.physicalDetails.sort((a,b) => a.loc.localeCompare(b.loc));

                    const systemDetailHtml = data.systemDetails.length > 0 ? `<ul class="summary-group-detail">${data.systemDetails.map(i => `<li>${i.qty} di ${i.loc}</li>`).join('')}</ul>` : '-';
                    const physicalDetailHtml = data.physicalDetails.length > 0 ? `<ul class="summary-group-detail">${data.physicalDetails.map(i => `<li>${i.qty} di ${i.loc}</li>`).join('')}</ul>` : '-';

                    const mainRow = summaryTableBody.insertRow();
                    mainRow.className = 'summary-group-header';
                    mainRow.innerHTML = `
                        <td>${data.description}</td>
                        <td>${data.totalSystemQty}</td>
                        <td>${data.totalPhysicalQty}</td>
                        <td class="selisih ${selisihClass}">${selisihText}</td>
                    `;
                    const detailRow = summaryTableBody.insertRow();
                    detailRow.innerHTML = `
                        <td></td>
                        <td class="details-cell">
                            <strong>Rincian Lokasi Sistem:</strong>
                            ${systemDetailHtml}
                        </td>
                        <td colspan="2" class="details-cell">
                            <strong>Rincian Lokasi Fisik:</strong>
                            ${physicalDetailHtml}
                        </td>
                    `;
                });
            }

            const unlisted = batch.physicalData.filter(p => p.type === 'unlisted');
            const groupedUnlisted = new Map(); 
            unlisted.forEach(item => {
                const descKey = item.description.toLowerCase();
                if (!groupedUnlisted.has(descKey)) {
                    groupedUnlisted.set(descKey, { description: item.description, total: 0, locations: [] });
                }
                const entry = groupedUnlisted.get(descKey);
                entry.total += item.quantity;
                entry.locations.push({ loc: item.location, qty: item.quantity });
            });

            if (groupedUnlisted.size === 0) {
                unlistedSummaryBody.innerHTML = '<tr><td colspan="2">Tidak ada barang temuan.</td></tr>';
            } else {
                Array.from(groupedUnlisted.values()).sort((a,b) => a.description.localeCompare(b.description)).forEach(data => {
                    data.locations.sort((a,b) => a.loc.localeCompare(b.loc));
                    const detailLokasiHtml = `<ul>${data.locations.map(l => `<li>${l.qty} di ${l.loc}</li>`).join('')}</ul>`;
                    
                    const mainRow = unlistedSummaryBody.insertRow();
                    mainRow.className = 'summary-group-header';
                    mainRow.innerHTML = `
                        <td>${data.description}</td>
                        <td>${data.total}</td>
                    `;
                    const detailRow = unlistedSummaryBody.insertRow();
                    detailRow.innerHTML = `
                        <td></td>
                        <td colspan="1" class="details-cell">
                            <strong>Rincian Lokasi:</strong>
                            ${detailLokasiHtml}
                        </td>
                    `;
                });
            }

            renderSummaryByLocation(batch);

            switchView('summary-view');
        };

        const renderSummaryByLocation = (batch) => {
            const locationSummary = new Map(); 

            // Add system quantities
            batch.initialData.forEach(item => {
                const loc = item.location.toLowerCase();
                if (!locationSummary.has(loc)) {
                    locationSummary.set(loc, { system: 0, physical: 0, systemItems: [], physicalItems: [] });
                }
                locationSummary.get(loc).system += item.quantity;
                locationSummary.get(loc).systemItems.push({ desc: item.description, qty: item.quantity });
            });

            // Add physical quantities (both 'found' and 'unlisted')
            batch.physicalData.forEach(p => {
                const loc = p.location.toLowerCase();
                if (!locationSummary.has(loc)) {
                    locationSummary.set(loc, { system: 0, physical: 0, systemItems: [], physicalItems: [] });
                }
                locationSummary.get(loc).physical += p.quantity;
                locationSummary.get(loc).physicalItems.push({ desc: p.description, qty: p.quantity, type: p.type });
            });

            if (locationSummary.size === 0) {
                locationSummaryBody.innerHTML = '<tr><td colspan="4">Tidak ada data stok untuk diringkas berdasarkan lokasi.</td></tr>';
                return;
            }

            const sortedLocations = Array.from(locationSummary.keys()).sort(); 

            locationSummaryBody.innerHTML = '';
            sortedLocations.forEach(loc => {
                const data = locationSummary.get(loc);
                const selisih = data.physical - data.system;
                let selisihClass = selisih > 0 ? 'positive' : (selisih < 0 ? 'negative' : 'zero');
                let selisihText = selisih > 0 ? `+${selisih}` : selisih;

                data.systemItems.sort((a,b) => a.desc.localeCompare(b.desc));
                data.physicalItems.sort((a,b) => a.desc.localeCompare(b.desc));

                const systemItemsHtml = data.systemItems.length > 0 ? `<ul>${data.systemItems.map(item => `<li>${item.desc}: ${item.qty}</li>`).join('')}</ul>` : '-';
                const physicalItemsHtml = data.physicalItems.length > 0 ? `<ul>${data.physicalItems.map(item => `<li>${item.desc}: ${item.qty} (${item.type === 'unlisted' ? 'temuan' : 'sistem'})</li>`).join('')}</ul>` : '-';

                const mainRow = locationSummaryBody.insertRow();
                mainRow.className = 'summary-group-header';
                mainRow.innerHTML = `
                    <td>${loc.toUpperCase()}</td>
                    <td>${data.system}</td>
                    <td>${data.physical}</td>
                    <td class="selisih ${selisihClass}">${selisihText}</td>
                `;
                const detailRow = locationSummaryBody.insertRow();
                detailRow.innerHTML = `
                    <td></td>
                    <td class="details-cell">
                        <strong>Rincian Item Sistem:</strong>
                        ${systemItemsHtml}
                    </td>
                    <td colspan="2" class="details-cell">
                        <strong>Rincian Item Fisik:</strong>
                        ${physicalItemsHtml}
                    </td>
                `;
            });
        };


        const downloadSummary = () => {
            if (appData.currentUserRole !== 'admin') {
                alert('Anda tidak memiliki izin untuk mengunduh ringkasan.');
                return;
            }
            const batch = appData.batches[currentBatchId];
            const wb = XLSX.utils.book_new();

            // Sheet 1: Perbandingan Stok (Deskripsi)
            const summaryDataHeaders = ["Deskripsi Barang", "Total Qty Sistem", "Total Qty Fisik", "Selisih Total", "Rincian Lokasi Sistem", "Rincian Lokasi Fisik"];
            const summaryDataRows = [];

            const groupedInitial = new Map();
            batch.initialData.forEach(item => {
                const descKey = item.description.toLowerCase();
                if (!groupedInitial.has(descKey)) {
                    groupedInitial.set(descKey, {
                        description: item.description,
                        systemDetails: [],
                        physicalDetails: [],
                        totalSystemQty: 0,
                        totalPhysicalQty: 0
                    });
                }
                const entry = groupedInitial.get(descKey);
                entry.systemDetails.push({ loc: item.location, qty: item.quantity });
                entry.totalSystemQty += item.quantity;
            });

            batch.physicalData.filter(p => p.type === 'found').forEach(p => {
                const initialItem = batch.initialData.find(item => item.id === p.initialId);
                const descKey = (initialItem ? initialItem.description : p.description).toLowerCase();
                if (groupedInitial.has(descKey)) { 
                    const entry = groupedInitial.get(descKey);
                    entry.physicalDetails.push({ loc: p.location, qty: p.quantity });
                    entry.totalPhysicalQty += p.quantity;
                }
            });

            Array.from(groupedInitial.values()).sort((a,b) => a.description.localeCompare(b.description)).forEach(data => {
                const selisih = data.totalPhysicalQty - data.totalSystemQty;
                data.systemDetails.sort((a,b) => a.loc.localeCompare(b.loc));
                data.physicalDetails.sort((a,b) => a.loc.localeCompare(b.loc));

                const systemDetailStr = data.systemDetails.map(i => `${i.qty} di ${i.loc}`).join('; ');
                const physicalDetailStr = data.physicalDetails.map(i => `${i.qty} di ${i.loc}`).join('; ');
                summaryDataRows.push([data.description, data.totalSystemQty, data.totalPhysicalQty, selisih, systemDetailStr, physicalDetailStr]);
            });

            const ws1 = XLSX.utils.aoa_to_sheet([summaryDataHeaders, ...summaryDataRows]);
            XLSX.utils.book_append_sheet(wb, ws1, 'Perbandingan Stok (Deskripsi)');

            // Sheet 2: Barang Temuan (Deskripsi)
            const unlistedDataHeaders = ["Deskripsi Barang", "Total Fisik", "Rincian Lokasi"];
            const unlisted = batch.physicalData.filter(p => p.type === 'unlisted');
            const groupedUnlisted = new Map();
            unlisted.forEach(item => {
                const descKey = item.description.toLowerCase();
                if (!groupedUnlisted.has(descKey)) {
                    groupedUnlisted.set(descKey, { description: item.description, total: 0, locations: [] });
                }
                const entry = groupedUnlisted.get(descKey);
                entry.total += item.quantity;
                entry.locations.push({ loc: item.location, qty: item.quantity });
            });

            const unlistedDataRows = [];
            Array.from(groupedUnlisted.values()).sort((a,b) => a.description.localeCompare(b.description)).forEach(data => {
                data.locations.sort((a,b) => a.loc.localeCompare(b.loc));
                const detailLokasiStr = data.locations.map(l => `${l.qty} di ${l.loc}`).join('; ');
                unlistedDataRows.push([data.description, data.total, detailLokasiStr]);
            });

            const ws2 = XLSX.utils.aoa_to_sheet([unlistedDataHeaders, ...unlistedDataRows]);
            XLSX.utils.book_append_sheet(wb, ws2, 'Barang Temuan (Deskripsi)');

            // Sheet 3: Summary Lokasi
            const locationSummaryHeaders = ["Lokasi", "Qty Sistem", "Qty Fisik (termasuk temuan)", "Selisih", "Rincian Item Sistem", "Rincian Item Fisik"];
            const locationSummary = new Map();

            batch.initialData.forEach(item => {
                const loc = item.location.toLowerCase();
                if (!locationSummary.has(loc)) {
                    locationSummary.set(loc, { system: 0, physical: 0, systemItems: [], physicalItems: [] });
                }
                locationSummary.get(loc).system += item.quantity;
                locationSummary.get(loc).systemItems.push({ desc: item.description, qty: item.quantity });
            });

            batch.physicalData.forEach(p => {
                const loc = p.location.toLowerCase();
                if (!locationSummary.has(loc)) {
                    locationSummary.set(loc, { system: 0, physical: 0, systemItems: [], physicalItems: [] });
                }
                locationSummary.get(loc).physical += p.quantity;
                locationSummary.get(loc).physicalItems.push({ desc: p.description, qty: p.quantity, type: p.type });
            });

            const locationSummaryRows = [];
            Array.from(locationSummary.keys()).sort().forEach(loc => {
                const data = locationSummary.get(loc);
                const selisih = data.physical - data.system;

                data.systemItems.sort((a,b) => a.desc.localeCompare(b.desc));
                data.physicalItems.sort((a,b) => a.desc.localeCompare(b.desc));

                const systemItemsStr = data.systemItems.map(item => `${item.desc}: ${item.qty}`).join('; ');
                const physicalItemsStr = data.physicalItems.map(item => `${item.desc}: ${item.qty} (${item.type === 'unlisted' ? 'temuan' : 'sistem'})`).join('; ');

                locationSummaryRows.push([loc.toUpperCase(), data.system, data.physical, selisih, systemItemsStr, physicalItemsStr]);
            });

            const ws3 = XLSX.utils.aoa_to_sheet([locationSummaryHeaders, ...locationSummaryRows]);
            XLSX.utils.book_append_sheet(wb, ws3, 'Summary Lokasi');

            XLSX.writeFile(wb, `${batch.name}_Ringkasan_Stok_Opname.xlsx`);
        };

        const downloadFullOpnameData = () => {
            const batch = appData.batches[currentBatchId];
            const wb = XLSX.utils.book_new();

            // Sheet 1: Data Stok Awal (Initial Data)
            const initialDataHeaders = ["ID Item", "Deskripsi Barang", "Lokasi Sistem", "Jumlah Sistem"];
            const initialDataRows = batch.initialData.map(item => [item.id, item.description, item.location, item.quantity]);
            const wsInitial = XLSX.utils.aoa_to_sheet([initialDataHeaders, ...initialDataRows]);
            XLSX.utils.book_append_sheet(wb, wsInitial, 'Data Stok Awal');

            // Sheet 2: Data Stok Fisik (Physical Data)
            const physicalDataHeaders = ["ID Fisik", "Tipe", "ID Item Sistem Terkait", "Deskripsi Barang", "Lokasi Fisik", "Jumlah Fisik"];
            const physicalDataRows = batch.physicalData.map(p => [
                p.id, 
                p.type === 'found' ? 'Tercatat Sistem' : 'Barang Temuan', 
                p.initialId || '', // InitialId might be null for unlisted items
                p.description, 
                p.location, 
                p.quantity
            ]);
            const wsPhysical = XLSX.utils.aoa_to_sheet([physicalDataHeaders, ...physicalDataRows]);
            XLSX.utils.book_append_sheet(wb, wsPhysical, 'Data Stok Fisik');

            XLSX.writeFile(wb, `${batch.name}_Data_Opname_Lengkap.xlsx`);
        };


        // --- Autofill Logic ---
        function setupAutofill(inputElement, suggestionsElement, sourceDataGetter) {
            let currentFocus = -1; // For keyboard navigation

            inputElement.addEventListener('input', () => {
                const inputValue = inputElement.value.toLowerCase();
                suggestionsElement.innerHTML = '';
                suggestionsElement.style.display = 'none'; // Hide by default
                currentFocus = -1;

                if (!inputValue || !currentBatchId) {
                    return;
                }

                const suggestions = new Set();
                sourceDataGetter().forEach(item => {
                    if (item.toLowerCase().includes(inputValue)) {
                        suggestions.add(item);
                    }
                });

                const sortedSuggestions = Array.from(suggestions).sort((a,b) => a.localeCompare(b));

                if (sortedSuggestions.length > 0) {
                    suggestionsElement.style.display = 'block';
                    sortedSuggestions.forEach((suggestion, index) => {
                        const div = document.createElement('div');
                        div.className = 'autocomplete-suggestion-item';
                        div.textContent = suggestion;
                        div.addEventListener('click', () => {
                            inputElement.value = suggestion;
                            suggestionsElement.innerHTML = '';
                            suggestionsElement.style.display = 'none';
                        });
                        suggestionsElement.appendChild(div);
                    });
                } 
            });

            // Keyboard navigation for suggestions
            inputElement.addEventListener('keydown', (e) => {
                let items = suggestionsElement.querySelectorAll('.autocomplete-suggestion-item');
                if (e.key === 'ArrowDown') {
                    currentFocus++;
                    addActive(items);
                    e.preventDefault(); 
                } else if (e.key === 'ArrowUp') {
                    currentFocus--;
                    addActive(items);
                    e.preventDefault(); 
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1) {
                        if (items[currentFocus]) {
                            items[currentFocus].click();
                        }
                    }
                } else if (e.key === 'Escape') {
                    suggestionsElement.innerHTML = '';
                    suggestionsElement.style.display = 'none';
                    currentFocus = -1;
                }
            });

            function addActive(items) {
                if (!items || items.length === 0) return false; // Added check for empty items
                removeActive(items);
                if (currentFocus >= items.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (items.length - 1);
                items[currentFocus].classList.add('active');
                items[currentFocus].scrollIntoView({ block: "nearest", inline: "nearest" }); 
            }

            function removeActive(items) {
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.remove('active');
                }
            }

            document.addEventListener('click', (e) => {
                if (!inputElement.contains(e.target) && !suggestionsElement.contains(e.target)) {
                    suggestionsElement.innerHTML = '';
                    suggestionsElement.style.display = 'none';
                    currentFocus = -1;
                }
            });
        }

        // Initialize autofill for "Tambah Barang Temuan Baru" modal
        setupAutofill(unlistedDescInput, unlistedDescSuggestions, () => {
            const batch = appData.batches[currentBatchId];
            if (!batch) return [];
            return Array.from(new Set([
                ...batch.initialData.map(item => item.description),
                ...batch.physicalData.map(p => p.description) // Include all physical data descriptions
            ]));
        });


        // --- Event Listeners ---
        newBatchForm.addEventListener('submit', createBatch);
        excelFileInput.addEventListener('change', handleFileUpload);
        downloadTemplateBtn.addEventListener('click', downloadTemplate);
        unlistedItemForm.addEventListener('submit', addUnlistedItem);

        userRoleSelectBatch.addEventListener('change', (e) => applyUserRole(e.target.value));
        userRoleSelectOpname.addEventListener('change', (e) => applyUserRole(e.target.value));
        userRoleSelectSummary.addEventListener('change', (e) => applyUserRole(e.target.value));

        searchOpnameInput.addEventListener('input', () => {
            currentPageOpname = 1; 
            renderOpnameItems();
        });
        searchUnlistedInput.addEventListener('input', () => {
            currentPageUnlisted = 1; 
            renderUnlistedItemsDisplay();
        });
        
        prevPageOpnameBtn.addEventListener('click', () => {
            if (currentPageOpname > 1) {
                currentPageOpname--;
                renderOpnameItems();
            }
        });
        nextPageOpnameBtn.addEventListener('click', () => {
            const batch = appData.batches[currentBatchId];
            const searchTerm = searchOpnameInput.value.toLowerCase();
            const groupedItemsMap = new Map();
            batch.initialData.forEach(item => {
                const descKey = item.description.toLowerCase();
                if (!groupedItemsMap.has(descKey)) groupedItemsMap.set(descKey, { description: item.description, items: [] });
                groupedItemsMap.get(descKey).items.push(item);
            });
            let filteredGroups = Array.from(groupedItemsMap.values()).filter(group => {
                if (group.description.toLowerCase().includes(searchTerm)) return true;
                return group.items.some(item => item.location.toLowerCase().includes(searchTerm));
            });
            const totalPages = Math.ceil(filteredGroups.length / ITEMS_PER_PAGE);

            if (currentPageOpname < totalPages) {
                currentPageOpname++;
                renderOpnameItems();
            }
        });

        prevPageUnlistedBtn.addEventListener('click', () => {
            if (currentPageUnlisted > 1) {
                currentPageUnlisted--;
                renderUnlistedItemsDisplay();
            }
        });
        nextPageUnlistedBtn.addEventListener('click', () => {
            const batch = appData.batches[currentBatchId];
            const searchTerm = searchUnlistedInput.value.toLowerCase();
            const groupedUnlistedMap = new Map();
            batch.physicalData.filter(p => p.type === 'unlisted').forEach(item => {
                const descKey = item.description.toLowerCase();
                if (!groupedUnlistedMap.has(descKey)) {
                    groupedUnlistedMap.set(descKey, { description: item.description, locations: [] });
                }
            });
            let filteredGroups = Array.from(groupedUnlistedMap.values()).filter(group => {
                return group.description.toLowerCase().includes(searchTerm);
            });
            const totalPages = Math.ceil(filteredGroups.length / ITEMS_PER_PAGE);

            if (currentPageUnlisted < totalPages) {
                currentPageUnlisted++;
                renderUnlistedItemsDisplay();
            }
        });


        // Modals general close
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close-btn')) {
                    modal.classList.remove('active');
                    // Reset unlisted item modal if closed
                    if (modal.id === 'unlisted-item-modal') {
                        unlistedDescInput.disabled = false; // Enable description input
                        unlistedItemForm.reset();
                    }
                }
            });
        });

        openUnlistedModalBtn.addEventListener('click', () => {
            unlistedItemModal.classList.add('active');
            unlistedDescInput.disabled = false; // Ensure description is enabled for new item
            unlistedItemForm.reset();
        });

        backToBatchListBtn.addEventListener('click', () => { 
            currentBatchId = null; 
            expandedGroups.clear(); 
            expandedUnlistedGroups.clear();
            switchView('batch-view'); 
        });
        viewSummaryBtn.addEventListener('click', () => { if(currentBatchId) renderSummary(); });
        backToOpnameBtn.addEventListener('click', () => { if(currentBatchId) switchView('opname-view'); });
        downloadSummaryExcelBtn.addEventListener('click', downloadSummary);
        downloadFullOpnameDataBtn.addEventListener('click', downloadFullOpnameData); // New listener

        // Initial render
        renderBatchList();
        switchView('batch-view');
    });
    </script>
</body>
</html>
